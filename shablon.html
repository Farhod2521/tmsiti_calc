<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xona Dizayni Kalkulyatori</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/1.11.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-blue: #4169E1;
            --success-green: #10B981;
            --dark-bg: #2C3E50;
        }
        
        body {
            background: #F1F5F9;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            padding-bottom: 2rem;
        }
        
        /* Progress Steps */
        .progress-box {
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            padding: 0;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .step-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #E2E8F0;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .step-item:last-child {
            border-bottom: none;
        }
        
        .step-item:hover {
            background: #F8FAFC;
        }
        
        .step-item.active {
            background: #F0F4FF;
        }
        
        .step-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-weight: 600;
            font-size: 0.875rem;
            flex-shrink: 0;
        }
        
        .step-number.completed {
            background: var(--primary-blue);
            color: white;
        }
        
        .step-number.active {
            background: var(--primary-blue);
            color: white;
        }
        
        .step-number.pending {
            background: #E2E8F0;
            color: #94A3B8;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1E293B;
            margin-bottom: 0.125rem;
        }
        
        .step-subtitle {
            font-size: 0.75rem;
            color: #64748B;
        }
        
        /* Parameters Box */
        .parameters-box {
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            padding: 0;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .parameters-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #E2E8F0;
            background: white;
        }
        
        .parameters-title {
            font-size: 1rem;
            font-weight: 700;
            color: #1E293B;
            margin: 0;
            display: flex;
            align-items: center;
        }
        
        .parameters-title i {
            margin-right: 0.5rem;
            color: var(--primary-blue);
        }
        
        .parameters-body {
            padding: 1.25rem;
        }
        
        .param-group {
            margin-bottom: 1.25rem;
        }
        
        .param-group:last-child {
            margin-bottom: 0;
        }
        
        .param-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1E293B;
            margin-bottom: 0.75rem;
            display: block;
        }
        
        .dimension-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .dimension-control:last-child {
            margin-bottom: 0;
        }
        
        .dimension-label {
            font-size: 1rem;
            color: #06080a;
            width: 50%;
        }
        
        .counter-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }
        
        .counter-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 1px solid #E2E8F0;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            color: #64748B;
        }
        
        .counter-btn:hover {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
            background: #F0F4FF;
        }
        
        .counter-value {
            font-size: 1rem;
            font-weight: 600;
            min-width: 50px;
            text-align: center;
            color: #1E293B;
        }
        
        /* Room Preview */
        .room-preview-card {
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            padding: 1.20rem;
        }
        
        .room-preview {
            margin-bottom: 10px;
            position: relative;
            display: inline-block;
        }
        
        .dimension-badge.bottom{
            top: 15%;
            left: 83%;
            transform: translateX(-50%);
        }
        
        .dimension-badge.top {
            top: 50%;
            right: 0%;
        }
        
        .dimension-badge.right  {
            top: 15%;
            right: 76%;
        }
        
        .room-image {
            width: 95%;
            max-height: 90%;
            border-radius: 6px;
            display: block;
            margin: 0 auto;
        }
        
        .dimension-badge {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 0.35rem 0.65rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            color: #1E293B;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        /* Result Cards */
        .result-card {
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            padding: 1.5rem;
            color: white;
            position: relative;
            overflow: hidden;
            height: 100%;
        }
        
        .result-card.blue {
            background: linear-gradient(135deg, #3B5BDB 0%, #364FC7 100%);
        }
        
        .result-card.green {
            background: linear-gradient(135deg, #12B886 0%, #0CA678 100%);
        }
        
        .result-label {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .result-value {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 0.5rem;
        }
        
        .result-unit {
            font-size: 1.25rem;
            font-weight: 500;
            opacity: 0.9;
        }
        
        .result-note {
            font-size: 0.75rem;
            opacity: 0.9;
            margin-top: 0.75rem;
        }
        
        /* Tech Table */
        .tech-table-card {
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }
        
        .tech-table-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #E2E8F0;
        }
        
        .tech-table-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1E293B;
            margin: 0;
        }
        
        .tech-table-subtitle {
            font-size: 0.75rem;
            color: #64748B;
            margin: 0;
        }
        
        .tech-table {
            width: 100%;
        }
        
        .tech-table th {
            background: #F8FAFC;
            padding: 0.75rem 1.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748B;
            text-transform: uppercase;
            border-bottom: 1px solid #E2E8F0;
        }
        
        .tech-table td {
            padding: 1rem 1.25rem;
            font-size: 0.875rem;
            color: #1E293B;
        }
        
        /* Light Cards */
        .lights-section {
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }
        
        .lights-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748B;
            margin-bottom: 1rem;
            text-transform: uppercase;
        }
        
        .light-card {
            text-align: center;
            padding: 1.25rem;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
            height: 100%;
        }
        
        .light-card:hover {
            border-color: var(--primary-blue);
            background: #F0F4FF;
        }
        
        .light-card.active {
            border-color: var(--primary-blue);
            background: #F0F4FF;
            box-shadow: 0 0 0 2px rgba(65, 105, 225, 0.2);
        }
        
        .light-icon {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 0.75rem;
            border-radius: 6px;
        }
        
        .light-name {
            font-weight: 600;
            font-size: 0.875rem;
            color: #1E293B;
            margin-bottom: 0.25rem;
            height: 40px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .light-desc {
            font-size: 0.75rem;
            color: #64748B;
        }
        
        /* Info Alert - Boshlang'ichda yashirin */
        .info-alert {
            background: #EFF6FF;
            border: 1px solid #DBEAFE;
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.75rem;
            color: #1E40AF;
            height: 12vh;
            display: none;
        }
        
        .info-alert.show {
            display: block;
        }
        
        .info-alert i {
            color: #3B82F6;
            margin-right: 0.5rem;
            font-size: 1.5rem;
        }
        
        /* Buttons */
        .btn-custom {
            padding: 0.625rem 1.25rem;
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: 8px;
        }
        
        /* Select Inputs */
        .form-select {
            font-size: 0.875rem;
            border-color: #E2E8F0;
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
        }
        
        .form-select:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 0.2rem rgba(65, 105, 225, 0.1);
        }
        
        /* Lamps Table */
        .lamps-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .lamps-table th {
            background: #F8FAFC;
            padding: 0.75rem 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748B;
            text-transform: uppercase;
            border-bottom: 1px solid #E2E8F0;
        }
        
        .lamps-table td {
            padding: 1rem;
            font-size: 0.875rem;
            color: #1E293B;
            border-bottom: 1px solid #E2E8F0;
        }
        
        .lamps-table tr:last-child td {
            border-bottom: none;
        }
        
        .lamp-image {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 4px;
        }
        
        /* AI Maslahatchi va Tafsiya bo'limlari - Boshlang'ichda yashirin */
        .ai-section {
            display: none;
        }
        
        .ai-section.show {
            display: block;
        }
        
        /* Chap karta - Mahsulot */
        .product-card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            height: 100%;
        }
        .product-header {
            display: flex;
            align-items: flex-start;
            gap: 24px;
            margin-bottom: 28px;
        }
        .product-image {
            width: 110px;
            height: 110px;
            object-fit: contain;
            border-radius: 8px;
            flex-shrink: 0;
            background: #f8fafc;
        }
        .badge-recommend {
            background: #e8f4fd;
            color: #2962d4;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        .badge-icon {
            font-size: 18px;
        }
        .product-title {
            font-size: 24px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 8px;
        }
        .product-desc {
            color: #718096;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 24px;
        }
        .specs-row {
            display: flex;
            gap: 40px;
            align-items: flex-start;
        }
        .spec-item {
            flex: 0 0 auto;
        }
        .spec-label {
            font-size: 12px;
            color: #a0aec0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            font-weight: 500;
        }
        .spec-value {
            font-size: 40px;
            font-weight: 700;
            color: #2962d4;
            line-height: 1;
        }
        .spec-divider {
            width: 1px;
            height: 60px;
            background: #e2e8f0;
            margin: 0;
        }
        .details-toggle {
            background: #f7fafc;
            border: none;
            width: 100%;
            padding: 16px 20px;
            border-radius: 10px;
            text-align: left;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            color: #2d3748;
            font-size: 14px;
            margin-top: 28px;
            transition: background 0.2s;
        }
        .details-toggle:hover {
            background: #edf2f7;
        }
        
        /* O'ng karta - AI Maslahatchi */
        .ai-card {
            background: #f7f9ff;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            height: 100%;
        }
        .ai-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        .ai-icon-wrapper {
            width: 48px;
            height: 48px;
            background: #e8eeff;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .ai-icon {
            font-size: 24px;
        }
        .ai-title {
            font-weight: 600;
            color: #2d3748;
            font-size: 16px;
        }
        .ai-message-box {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .ai-content {
            color: #4a5568;
            font-size: 14px;
            line-height: 1.7;
            margin-bottom: 16px;
        }
        .ai-content strong {
            color: #2962d4;
            font-weight: 600;
        }
        /* Typing animatsiyasi uchun */
        .typing-dots {
            display: inline-flex;
            align-items: center;
        }

        .typing-dots span {
            animation: typing 1.4s infinite;
            opacity: 0;
            margin: 0 2px;
        }

        .typing-dots span:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* AI bo'limi uchun qo'shimcha stillar */
        .ai-loading {
            color: #666;
            font-style: italic;
        }
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .tag {
            background: #f0f0f5;
            color: #6b7280;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        .btn-variants {
            background: white;
            border: 1px solid #e2e8f0;
            width: 100%;
            padding: 14px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            color: #2d3748;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        .btn-variants:hover {
            border-color: #cbd5e0;
            background: #fafafa;
        }
        
        /* Kategoriya bo'yicha lampochkalar jadvali */
        .category-lamps-section {
            margin-top: 20px;
            display: none;
        }
        
        .category-lamps-section.show {
            display: block;
        }
        
        .category-lamps-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .category-lamps-table th {
            background: #f8fafc;
            padding: 12px 15px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748B;
            text-transform: uppercase;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .category-lamps-table td {
            padding: 15px;
            font-size: 0.875rem;
            color: #1E293B;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .category-lamps-table tr:hover {
            background: #f8fafc;
        }
        
        .category-image {
            width: 50px;
            height: 50px;
            object-fit: contain;
            border-radius: 4px;
        }
        
        @media (max-width: 768px) {
            .result-value {
                font-size: 2rem;
            }
            
            .dimension-badge {
                font-size: 0.625rem;
                padding: 0.25rem 0.5rem;
            }
            
            .room-preview-card {
                margin-top: 1.5rem;
            }
            
            .specs-row {
                flex-direction: column;
                gap: 20px;
            }
            
            .spec-divider {
                display: none;
            }
            
            .product-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .product-image {
                width: 100px;
                height: 100px;
            }
        }
        
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="row g-4">
            <div class="col-lg-1"></div>
            <div class="col-lg-5">
                <div class="parameters-box">
                    <div class="parameters-header">
                        <h2 class="parameters-title">
                            <i class="bi bi-rulers"></i>
                            Xona o'lchamlari (Metr)
                        </h2>
                    </div>
                    
                    <div class="parameters-body">
                        <div class="param-group">
                            <div class="dimension-control">
                                <span class="dimension-label">Xona kenglikgi</span>
                                <div class="counter-wrapper">
                                    <button class="counter-btn" onclick="changeDimension('width', -0.1)">âˆ’</button>
                                    <div class="counter-value" id="width">3.0</div>
                                    <button class="counter-btn" onclick="changeDimension('width', 0.1)">+</button>
                                </div>
                            </div>
                            
                            <div class="dimension-control">
                                <span class="dimension-label">Xona uzunligi</span>
                                <div class="counter-wrapper">
                                    <button class="counter-btn" onclick="changeDimension('length', -0.1)">âˆ’</button>
                                    <div class="counter-value" id="length">3.0</div>
                                    <button class="counter-btn" onclick="changeDimension('length', 0.1)">+</button>
                                </div>
                            </div>
                            
                            <div class="dimension-control">
                                <span class="dimension-label">Xona balandligi</span>
                                <div class="counter-wrapper">
                                    <button class="counter-btn" onclick="changeDimension('height', -0.1)">âˆ’</button>
                                    <div class="counter-value" id="height">3.0</div>
                                    <button class="counter-btn" onclick="changeDimension('height', 0.1)">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Parameters Box 2 -->
                <div class="parameters-box">
                    <div class="parameters-header">
                        <h2 class="parameters-title">
                            <i class="bi bi-sliders"></i>
                            Qo'shimcha parametrlar
                        </h2>
                    </div>
                    
                    <div class="parameters-body">
                        <div class="param-group">
                            <label class="param-label">Bino toifasi</label>
                            <select class="form-select" id="buildingType" onchange="onBuildingTypeChange()">
                                <option value="">-- Bino toifasini tanlang --</option>
                                <!-- API dan yuklanadi -->
                            </select>
                        </div>
                        
                        <div class="param-group">
                            <label class="param-label">Xona turi</label>
                            <select class="form-select" id="roomType" onchange="onRoomTypeChange()" disabled>
                                <option value="">-- Avval bino turini tanlang --</option>
                                <!-- API dan yuklanadi -->
                            </select>
                        </div>
                        
                        <div class="param-group">
                            <label class="param-label">Ranglar kombinatsiyasi</label>
                            <select class="form-select" id="colorScheme" onchange="calculateLamps()">
                                <option value="">-- Rang kombinatsiyasini tanlang --</option>
                                <option value="80/80/30">Juda och ranglar (80/80/30)</option>
                                <option value="80/50/30">Och ranglar (80/50/30)</option>
                                <option value="70/50/20">O'rtacha och ranglar (70/50/20)</option>
                                <option value="50/50/10">O'rtacha ranglar (50/50/10)</option>
                                <option value="50/30/10">Kulrang / qorong'i kulrang (50/30/10)</option>
                                <option value="30/30/10">Qorong'i ranglar (30/30/10)</option>
                                <option value="0/0/0">Juda qorong'i (0/0/0)</option>
                            </select>
                        </div>
                        <div class="param-group">
                            <label class="param-label">Xona tozalik koeffitsienti</label>
                            <select class="form-select" id="roomCleanliness" onchange="calculateLamps()">
                                <option value="">-- Xona tozaligini tanlang --</option>
                                <option value="1.25">Juda toza xona (1.25)</option>
                                <option value="1.5">Toza xona (1.5)</option>
                                <option value="1.75">O'rtacha toza (1.75)</option>
                                <option value="2">Uncha yaxshi emas (2)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Info Alert - Boshlang'ichda yashirin -->
                <div class="info-alert" id="lightingInfoAlert">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-info-circle flex-shrink-0"></i>
                        <div id="lightingInfo">
                            <strong>SHNQ 2.01.05-19 ("Tabiiy va sun'iy yoritish") talablariga muvofiq</strong>,
                            <span id="buildingTypeText">tanlangan bino toifasi</span>ga mansub
                            <span id="roomTypeText">tanlangan xona turi</span> uchun
                            minimal yoritish darajasi
                            <strong><span id="luxValue">---</span> Lk</strong>
                            bo'lishi talab etiladi.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Center Column - Room Preview -->
            <div class="col-lg-6">
                <div class="room-preview-card">
                    <div class="room-preview">
                        <img src="images/room.jpg" class="room-image" alt="Xona rasmi">

                        <div class="dimension-badge top">
                            <span id="dimTop">3.0 m</span>
                        </div>

                        <div class="dimension-badge right">
                            <span id="dimRight">3.0 m</span>
                        </div>

                        <div class="dimension-badge bottom">
                           <span id="dimBottom">3.0 m</span>
                        </div>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6 col-lg-6">
                            <div class="result-card blue">
                                <div class="result-label">Umumiy maydon</div>
                                <div class="d-flex align-items-baseline">
                                    <div class="result-value" id="area">9.00</div>
                                    <div class="result-unit ms-2">mÂ²</div>
                                </div>
                                <div class="result-note">
                                    <i class="bi bi-calendar-check me-1"></i>Kvadrat metrda
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-6">
                            <div class="result-card green">
                                <div class="result-label">Umumiy yorug'lik oqimi</div>
                                <div class="d-flex align-items-baseline">
                                    <div class="result-value" id="lumen">0</div>
                                    <div class="result-unit ms-2">lm</div>
                                </div>
                                <div class="result-note">
                                    <i class="bi bi-check-circle me-1"></i>Bino va xona turini tanlang
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- AI Maslahatchi va Tavsiya bo'limlari - Boshlang'ichda yashirin -->

                
                <!-- Lamps Table Section (PASTDA joylashadi) -->
                <div class="tech-table-card" id="lampsTableContainer" style="display: none;">
                    <div class="tech-table-header">
                        <div class="tech-table-title" id="lampsTableTitle">Lampochkalar ro'yxati</div>
                        <div class="tech-table-subtitle">Quvvat bo'yicha tartiblangan</div>
                    </div>
                    <div class="table-responsive">
                        <table class="lamps-table" id="lampsTable">
                            <thead>
                                <tr>
                                    <th>Rasmi</th>
                                    <th>Nomi</th>
                                    <th>Quvvat</th>
                                    <th>Yorug'lik oqimi</th>
                                    <th>O'lchamlari</th>
                                </tr>
                            </thead>
                            <tbody id="lampsTableBody">
                                <!-- Lampochkalar shu yerga joylashtiriladi -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-lg-1"></div>
            <div class="col-lg-11">
                                <div class="ai-section" id="aiSection">
                    <div class="row g-3 mt-4">
                        <!-- Chap - Mahsulot kartasi (col-lg-8) -->
                        <div class="col-lg-8">
                            <div class="product-card" id="productCard">
                                <div class="product-header">
                                    <img src="" alt="LED Lampa" class="product-image" id="productImage">
                                    
                                    <div class="flex-grow-1">
                                        <div class="badge-recommend">
                                            <span class="badge-icon">âœ“</span>
                                            BIZNING TAVSIYAMIZ
                                        </div>
                                        <h1 class="product-title" id="productTitle">LED Lampa</h1>
                                        <p class="product-desc" id="productDesc">Xonaning o'lcham va yoritish talablariga eng mos keladigan variant.</p>
                                        
                                        <div class="specs-row">
                                            <div class="spec-item">
                                                <div class="spec-label">KERAKLI SONI</div>
                                                <div class="spec-value" id="requiredCount">---</div>
                                            </div>
                                            <div class="spec-divider"></div>
                                            <div class="spec-item">
                                                <div class="spec-label">QUVVAT</div>
                                                <div class="spec-value" id="totalPower">---</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <button class="details-toggle" onclick="toggleCategoryLamps()">
                                    <span>Barcha lampochka turlarini ko'rish</span>
                                    <span>â–¼</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- O'ng - AI Maslahatchi (col-lg-4) -->
                        <div class="col-lg-4">
                            <div class="ai-card">
                                <div class="ai-header">
                                    <div class="ai-icon-wrapper">
                                        <span class="ai-icon">ðŸ¤–</span>
                                    </div>
                                    <div class="ai-title">AI Maslahatchi</div>
                                </div>
                                
                                <div class="ai-message-box">
                                    <div class="ai-content" id="aiAdvice">
                                        Xona turi va ranglar kombinatsiyasi tanlang. AI maslahatchi sizga eng yaxshi yoritish variantini tavsiya qiladi.
                                    </div>
                                    
                                    <div class="tags-container">
                                        <span class="tag" id="efficiencyTag">Tejamkorlik: ---</span>
                                        <span class="tag" id="brightnessTag">Yorug'lik: ---</span>
                                    </div>
                                </div>
                                
                                <button class="btn-variants" onclick="showAlternativeVariants()">
                                    <span>Boshqa variantlarni ko'rish</span>
                                    <span>â†’</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Kategoriya bo'yicha lampochkalar jadvali -->
                    <div class="category-lamps-section" id="categoryLampsSection">
                        <div class="tech-table-card mt-4">
                            <div class="tech-table-header">
                                <div class="tech-table-title" id="categoryLampsTitle">Barcha lampochka turlari</div>
                                <div class="tech-table-subtitle">Kategoriya bo'yicha tartiblangan</div>
                            </div>
                            <div class="table-responsive">
                                <table class="category-lamps-table" id="categoryLampsTable">
                                    <thead>
                                        <tr>
                                            <th>Rasmi</th>
                                            <th>Nomi</th>
                                            <th>Kategoriya</th>
                                            <th>Kerakli soni</th>
                                            <th>Quvvat (bitta)</th>
                                            <th>Jami quvvat</th>
                                        </tr>
                                    </thead>
                                    <tbody id="categoryLampsBody">
                                        <!-- Kategoriya lampochkalari shu yerga joylashtiriladi -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-1"></div>
            
            <!-- Right Column - Results -->
            <div class="col-lg-11">
                <!-- Technical Requirements Table -->
                <div class="tech-table-card">
                    <table class="tech-table">
                        <thead>
                            <tr>
                                <th>KATEGORIYA</th>
                                <th>LK (LM/MÂ²)</th>
                                <th>RA (CRI)</th>
                                <th>UGR</th>
                            </tr>
                        </thead>
                        <tbody id="techTableBody">
                            <tr>
                                <td colspan="4" class="text-center text-muted">Bino va xona turini tanlang</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Recommended Lighting -->
                <!-- <div class="lights-section">
                    <div class="lights-title">LAMPOCHKA TURLARI</div>
                    <div class="row g-3" id="recommendedLights">
                      
                        <div class="col-12 text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Yuklanmoqda...</span>
                            </div>
                        </div>
                    </div>
                </div> -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // O'zgaruvchilar
        let dimensions = {
            width: 3.0,
            length: 3.0,
            height: 3.0
        };
        
        let currentLk = 0;
        let buildingCategories = [];
        let roomCategories = [];
        let roomDetails = [];
        let allLamps = [];
        let lampGroups = {};
        let selectedLampType = '';
        let calculatedLampsByCategory = {}; // Kategoriya bo'yicha hisoblangan lampochkalar
        let currentCleanlinessCoefficient = 1.5;
        // Light indeks ma'lumotlari
        const lightIndices = [
            {
                "indeks": 0.40,
                "koeffitsientlar": [
                    { "rang": "80/80/30", "qiymat": 0.45 },
                    { "rang": "80/50/30", "qiymat": 0.25 },
                    { "rang": "70/50/20", "qiymat": 0.23 },
                    { "rang": "50/50/10", "qiymat": 0.22 },
                    { "rang": "50/30/10", "qiymat": 0.18 },
                    { "rang": "30/30/10", "qiymat": 0.18 },
                    { "rang": "0/0/0", "qiymat": 0.14 }
                ]
            },
            {
                "indeks": 0.50,
                "koeffitsientlar": [
                    { "rang": "80/80/30", "qiymat": 0.50 },
                    { "rang": "80/50/30", "qiymat": 0.28 },
                    { "rang": "70/50/20", "qiymat": 0.25 },
                    { "rang": "50/50/10", "qiymat": 0.24 },
                    { "rang": "50/30/10", "qiymat": 0.20 },
                    { "rang": "30/30/10", "qiymat": 0.20 },
                    { "rang": "0/0/0", "qiymat": 0.16 }
                ]
            },
            {
                "indeks": 0.60,
                "koeffitsientlar": [
                    { "rang": "80/80/30", "qiymat": 0.55 },
                    { "rang": "80/50/30", "qiymat": 0.30 },
                    { "rang": "70/50/20", "qiymat": 0.27 },
                    { "rang": "50/50/10", "qiymat": 0.26 },
                    { "rang": "50/30/10", "qiymat": 0.22 },
                    { "rang": "30/30/10", "qiymat": 0.22 },
                    { "rang": "0/0/0", "qiymat": 0.18 }
                ]
            },
            {
                "indeks": 0.70,
                "koeffitsientlar": [
                    { "rang": "80/80/30", "qiymat": 0.60 },
                    { "rang": "80/50/30", "qiymat": 0.32 },
                    { "rang": "70/50/20", "qiymat": 0.29 },
                    { "rang": "50/50/10", "qiymat": 0.28 },
                    { "rang": "50/30/10", "qiymat": 0.24 },
                    { "rang": "30/30/10", "qiymat": 0.24 },
                    { "rang": "0/0/0", "qiymat": 0.20 }
                ]
            }
        ];
        // AI Maslahatchi uchun alohida hisoblash funksiyasi
        function calculateAIAdvisor() {
            // AI uchun doimiy qiymatlar (rasmdagi kabi)
            const aiMF = 0.80; // Maintenance Factor
            const aiUF = 0.60; // Utilization Factor (taxminiy)
            
            // Xona parametrlari
            const width = dimensions.width;
            const length = dimensions.length;
            const area = width * length;
            const lk = currentLk || 150; // Agar currentLk bo'lmasa, 150 lux
            
            // Ishchi balandlik (rasmdagi kabi)
            const workHeight = 0.8; // Ishchi tekislik
            const ceilingHeight = dimensions.height;
            const hm = ceilingHeight - workHeight; // Hm = 2.2 m (rasmdagi misolda)
            
            // Room Index hisoblash (faqat tekshiruv uchun)
            const k = (length * width) / (hm * (length + width));
            
            // Umumiy yorug'lik oqimini hisoblash (rasmdagi formula)
            const totalLumens = Math.round((lk * area) / (aiUF * aiMF));
            
            return {
                area: area,
                requiredLux: lk,
                roomHeight: hm,
                roomIndex: k,
                totalLumens: totalLumens,
                maintenanceFactor: aiMF,
                utilizationFactor: aiUF
            };
        }
                // 1. Dastur yuklanganda bino toifalarini va lampochkalarni yuklash
        document.addEventListener('DOMContentLoaded', async function() {
            await Promise.all([
                loadBuildingCategories(),
                loadAllLamps()
            ]);
        });
        
        // 2. Bino toifalarini yuklash
        async function loadBuildingCategories() {
            try {
                const response = await fetch('https://calc.tmsiti.uz/api/v1/lightbulb/room_categories/');
                buildingCategories = await response.json();
                
                const buildingSelect = document.getElementById('buildingType');
                
                buildingCategories.forEach(building => {
                    const option = document.createElement('option');
                    option.value = building.id;
                    option.textContent = building.name;
                    buildingSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Bino toifalarini yuklashda xatolik:', error);
            }
        }
        
        // 3. Barcha lampochkalarni yuklash va avtomatik guruhlash
        async function loadAllLamps() {
            try {
                const response = await fetch('https://calc.tmsiti.uz/api/v1/lightbulb/led-panels/');
                allLamps = await response.json();
                
                lampGroups = smartGroupLamps(allLamps);
                populateRecommendedLights(lampGroups);
                
            } catch (error) {
                console.error('Lampochkalarni yuklashda xatolik:', error);
            }
        }
        
        // 4. Smart guruhlash funksiyasi
        function smartGroupLamps(lamps) {
            const groups = {};
            
            const keywords = {
                'Ð¿Ð°Ð½ÐµÐ»Ð¸ Ñ‡ÐµÑ‚Ñ‹Ñ€ÐµÑ… ÑƒÐ³Ð¾Ð»ÑŒÐ½Ñ‹Ð¹': 'LED Ð¿Ð°Ð½ÐµÐ»Ð¸ Ñ‡ÐµÑ‚Ñ‹Ñ€ÐµÑ… ÑƒÐ³Ð¾Ð»ÑŒÐ½Ñ‹Ð¹',
                'Ñ‡ÐµÑ‚Ñ‹Ñ€ÐµÑ…ÑƒÐ³Ð¾Ð»ÑŒÐ½Ñ‹Ð¹': 'LED Ð¿Ð°Ð½ÐµÐ»Ð¸ Ñ‡ÐµÑ‚Ñ‹Ñ€ÐµÑ… ÑƒÐ³Ð¾Ð»ÑŒÐ½Ñ‹Ð¹',
                'Ñ‡ÐµÑ‚Ñ‹Ñ€ÐµÑ… ÑƒÐ³Ð¾Ð»ÑŒÐ½Ñ‹Ð¹': 'LED Ð¿Ð°Ð½ÐµÐ»Ð¸ Ñ‡ÐµÑ‚Ñ‹Ñ€ÐµÑ… ÑƒÐ³Ð¾Ð»ÑŒÐ½Ñ‹Ð¹',
                'Ð¿Ð°Ð½ÐµÐ»ÑŒ ÐºÐ²Ð°Ð´Ñ€Ð°Ñ‚': 'LED Ð¿Ð°Ð½ÐµÐ»Ð¸ Ñ‡ÐµÑ‚Ñ‹Ñ€ÐµÑ… ÑƒÐ³Ð¾Ð»ÑŒÐ½Ñ‹Ð¹',
                'ÐºÐ°Ð¿ÑÑƒÐ»Ñ‹': 'Led Ð»Ð°Ð¼Ð¿Ñ‹ Ð² Ñ„Ð¾Ñ€Ð¼Ðµ ÐºÐ°Ð¿ÑÑƒÐ»Ñ‹',
                'capsule': 'Led Ð»Ð°Ð¼Ð¿Ñ‹ Ð² Ñ„Ð¾Ñ€Ð¼Ðµ ÐºÐ°Ð¿ÑÑƒÐ»Ñ‹',
                'ÐºÐ°Ð¿ÑÑƒÐ»ÑŒÐ½Ð°Ñ': 'Led Ð»Ð°Ð¼Ð¿Ñ‹ Ð² Ñ„Ð¾Ñ€Ð¼Ðµ ÐºÐ°Ð¿ÑÑƒÐ»Ñ‹',
                'Ð¿Ð°Ð½ÐµÐ»Ð¸ ÐºÑ€ÑƒÐ³Ð»Ñ‹Ðµ': 'LED Ð¿Ð°Ð½ÐµÐ»Ð¸ ÐºÑ€ÑƒÐ³Ð»Ñ‹Ðµ',
                'ÐºÑ€ÑƒÐ³Ð»Ð°Ñ Ð¿Ð°Ð½ÐµÐ»ÑŒ': 'LED Ð¿Ð°Ð½ÐµÐ»Ð¸ ÐºÑ€ÑƒÐ³Ð»Ñ‹Ðµ',
                'round panel': 'LED Ð¿Ð°Ð½ÐµÐ»Ð¸ ÐºÑ€ÑƒÐ³Ð»Ñ‹Ðµ',
                'Ð½Ð°ÐºÐ»Ð°Ð´Ð½Ñ‹Ðµ ÐºÑ€ÑƒÐ³Ð»Ñ‹Ðµ': 'Led Ð¿Ð°Ð½ÐµÐ»Ð¸ Ð½Ð°ÐºÐ»Ð°Ð´Ð½Ñ‹Ðµ ÐºÑ€ÑƒÐ³Ð»Ñ‹Ðµ',
                'Ð½Ð°ÐºÐ»Ð°Ð´Ð½Ð°Ñ ÐºÑ€ÑƒÐ³Ð»Ð°Ñ': 'Led Ð¿Ð°Ð½ÐµÐ»Ð¸ Ð½Ð°ÐºÐ»Ð°Ð´Ð½Ñ‹Ðµ ÐºÑ€ÑƒÐ³Ð»Ñ‹Ðµ',
                'Ð»Ð¸Ð½ÐµÐ¹Ð½Ñ‹Ðµ': 'LED Ð»Ð°Ð¼Ð¿Ñ‹ Ð»Ð¸Ð½ÐµÐ¹Ð½Ñ‹Ðµ',
                'linear': 'LED Ð»Ð°Ð¼Ð¿Ñ‹ Ð»Ð¸Ð½ÐµÐ¹Ð½Ñ‹Ðµ',
                'Ð»Ð¸Ð½ÐµÐ¹Ð½Ð°Ñ': 'LED Ð»Ð°Ð¼Ð¿Ñ‹ Ð»Ð¸Ð½ÐµÐ¹Ð½Ñ‹Ðµ',
                'Ð¿Ñ€Ð¾Ð¶ÐµÐºÑ‚Ð¾Ñ€': 'LED Ð¿Ñ€Ð¾Ð¶ÐµÐºÑ‚Ð¾Ñ€Ñ‹',
                'projector': 'LED Ð¿Ñ€Ð¾Ð¶ÐµÐºÑ‚Ð¾Ñ€Ñ‹',
                'Ð¿Ñ€Ð¾Ð¶ÐµÐºÑ‚Ð¾Ñ€Ñ‹': 'LED Ð¿Ñ€Ð¾Ð¶ÐµÐºÑ‚Ð¾Ñ€Ñ‹',
                'Ð¿Ð¾Ñ‚Ð¾Ð»Ð¾Ñ‡Ð½Ñ‹Ðµ': 'LED ÑÐ²ÐµÑ‚Ð¸Ð»ÑŒÐ½Ð¸ÐºÐ¸ Ð¿Ð¾Ñ‚Ð¾Ð»Ð¾Ñ‡Ð½Ñ‹Ðµ',
                'ceiling': 'LED ÑÐ²ÐµÑ‚Ð¸Ð»ÑŒÐ½Ð¸ÐºÐ¸ Ð¿Ð¾Ñ‚Ð¾Ð»Ð¾Ñ‡Ð½Ñ‹Ðµ',
                'Ð¿Ð¾Ñ‚Ð¾Ð»Ð¾Ñ‡Ð½Ñ‹Ð¹': 'LED ÑÐ²ÐµÑ‚Ð¸Ð»ÑŒniki Ð¿Ð¾Ñ‚Ð¾Ð»Ð¾Ñ‡Ð½Ñ‹Ðµ',
                'Ð»ÐµÐ½Ñ‚': 'LED ÑÐ²ÐµÑ‚Ð¾Ð´Ð¸Ð¾Ð´Ð½Ñ‹Ðµ Ð»ÐµÐ½Ñ‚Ñ‹',
                'strip': 'LED ÑÐ²ÐµÑ‚Ð¾Ð´Ð¸Ð¾Ð´Ð½Ñ‹Ðµ Ð»ÐµÐ½Ñ‚Ñ‹',
                'Ð»ÐµÐ½Ñ‚Ð°': 'LED ÑÐ²ÐµÑ‚Ð¾Ð´Ð¸Ð¾Ð´Ð½Ñ‹Ðµ Ð»ÐµÐ½Ñ‚Ñ‹'
            };
            
            lamps.forEach(lamp => {
                if (lamp.name) {
                    const nameLower = lamp.name.toLowerCase();
                    let groupFound = false;
                    
                    for (const [keyword, groupName] of Object.entries(keywords)) {
                        if (nameLower.includes(keyword.toLowerCase())) {
                            if (!groups[groupName]) {
                                groups[groupName] = [];
                            }
                            groups[groupName].push(lamp);
                            groupFound = true;
                            break;
                        }
                    }
                    
                    if (!groupFound) {
                        const words = lamp.name.split(' ');
                        if (words.length >= 2) {
                            const mainType = words[0] + ' ' + words[1];
                            if (!groups[mainType]) {
                                groups[mainType] = [];
                            }
                            groups[mainType].push(lamp);
                        } else {
                            if (!groups['Boshqa']) {
                                groups['Boshqa'] = [];
                            }
                            groups['Boshqa'].push(lamp);
                        }
                    }
                }
            });
            
            return groups;
        }
        
        // 5. Tavsiya etilgan chiroqlarni to'ldirish
        function populateRecommendedLights(groups) {
            const recommendedLights = document.getElementById('recommendedLights');
            recommendedLights.innerHTML = '';
            
            const mainGroups = [
                'LED Ð¿Ð°Ð½ÐµÐ»Ð¸ Ñ‡ÐµÑ‚Ñ‹Ñ€ÐµÑ… ÑƒÐ³Ð¾Ð»ÑŒÐ½Ñ‹Ð¹',
                'Led Ð»Ð°Ð¼Ð¿Ñ‹ Ð² Ñ„Ð¾Ñ€Ð¼Ðµ ÐºÐ°Ð¿ÑÑƒÐ»Ñ‹',
                'LED Ð¿Ð°Ð½ÐµÐ»Ð¸ ÐºÑ€ÑƒÐ³Ð»Ñ‹Ðµ',
                'Led Ð¿Ð°Ð½ÐµÐ»Ð¸ Ð½Ð°ÐºÐ»Ð°Ð´Ð½Ñ‹Ðµ ÐºÑ€ÑƒÐ³Ð»Ñ‹Ðµ',
                'LED Ð»Ð°Ð¼Ð¿Ñ‹ Ð»Ð¸Ð½ÐµÐ¹Ð½Ñ‹Ðµ',
                'LED Ð¿Ñ€Ð¾Ð¶ÐµÐºÑ‚Ð¾Ñ€Ñ‹',
                'LED ÑÐ²ÐµÑ‚Ð¸Ð»ÑŒniki Ð¿Ð¾Ñ‚Ð¾Ð»Ð¾Ñ‡Ð½Ñ‹Ðµ',
                'LED ÑÐ²ÐµÑ‚Ð¾Ð´Ð¸Ð¾Ð´Ð½Ñ‹Ðµ Ð»ÐµÐ½Ñ‚Ñ‹'
            ];
            
            let displayedGroups = 0;
            
            mainGroups.forEach(type => {
                const lampsInGroup = groups[type] || [];
                const lampCount = lampsInGroup.length;
                
                if (lampCount > 0 && displayedGroups < 8) {
                    const col = document.createElement('div');
                    col.className = 'col-md-3';
                    
                    const firstLamp = lampsInGroup[0];
                    const lampImage = firstLamp.image || 'https://via.placeholder.com/60x60?text=No+Image';
                    
                    col.innerHTML = `
                        <div class="light-card" onclick="showLampsByType('${type}')">
                            <img src="${lampImage}" alt="${type}" class="light-icon">
                            <div class="light-name">${type}</div>
                            <div class="light-desc">${lampCount} xil model</div>
                        </div>
                    `;
                    
                    recommendedLights.appendChild(col);
                    displayedGroups++;
                }
            });
            
            if (displayedGroups < 8) {
                Object.keys(groups).forEach(type => {
                    if (!mainGroups.includes(type) && displayedGroups < 8) {
                        const lampsInGroup = groups[type] || [];
                        const lampCount = lampsInGroup.length;
                        
                        if (lampCount > 0) {
                            const col = document.createElement('div');
                            col.className = 'col-md-3';
                            
                            const firstLamp = lampsInGroup[0];
                            const lampImage = firstLamp.image || 'https://via.placeholder.com/60x60?text=No+Image';
                            
                            col.innerHTML = `
                                <div class="light-card" onclick="showLampsByType('${type}')">
                                    <img src="${lampImage}" alt="${type}" class="light-icon">
                                    <div class="light-name">${type}</div>
                                    <div class="light-desc">${lampCount} xil model</div>
                                </div>
                            `;
                            
                            recommendedLights.appendChild(col);
                            displayedGroups++;
                        }
                    }
                });
            }
            
            if (displayedGroups === 0) {
                recommendedLights.innerHTML = `
                    <div class="col-12 text-center">
                        <div class="text-muted">Lampochkalar topilmadi</div>
                    </div>
                `;
            }
        }
        
        // 6. Bino toifasi tanlanganda
        async function onBuildingTypeChange() {
            const buildingSelect = document.getElementById('buildingType');
            const roomSelect = document.getElementById('roomType');
            const selectedBuildingId = buildingSelect.value;
            
            if (!selectedBuildingId) {
                roomSelect.innerHTML = '<option value="">-- Avval bino turini tanlang --</option>';
                roomSelect.disabled = true;
                clearTechTable();
                resetLumen();
                hideAIandRecommendation();
                return;
            }
            
            const selectedBuilding = buildingCategories.find(b => b.id == selectedBuildingId);
            if (selectedBuilding) {
                document.getElementById('buildingTypeText').textContent = selectedBuilding.name;
            }
            
            try {
                const response = await fetch(`https://calc.tmsiti.uz/api/v1/lightbulb/api/room-categories/${selectedBuildingId}/`);
                const roomData = await response.json();
                roomCategories = roomData.subcategories;
                
                roomSelect.innerHTML = '<option value="">-- Xona turini tanlang --</option>';
                roomCategories.forEach(room => {
                    const option = document.createElement('option');
                    option.value = room.id;
                    option.textContent = room.name;
                    roomSelect.appendChild(option);
                });
                
                roomSelect.disabled = false;
                clearTechTable();
                resetLumen();
                hideAIandRecommendation();
                
            } catch (error) {
                console.error('Xona toifalarini yuklashda xatolik:', error);
            }
        }
        
        // 7. Xona turi tanlanganda
        async function onRoomTypeChange() {
            const roomSelect = document.getElementById('roomType');
            const selectedRoomId = roomSelect.value;
            
            if (!selectedRoomId) {
                clearTechTable();
                resetLumen();
                hideAIandRecommendation();
                return;
            }
            
            const selectedRoom = roomCategories.find(r => r.id == selectedRoomId);
            if (selectedRoom) {
                document.getElementById('roomTypeText').textContent = selectedRoom.name;
            }
            
            try {
                const response = await fetch(`https://calc.tmsiti.uz/api/v1/lightbulb/rooms/${selectedRoomId}/`);
                roomDetails = await response.json();
                
                updateTechTable();
                calculate();
                document.getElementById('lightingInfoAlert').classList.add('show');
                
            } catch (error) {
                console.error('Xona tafsilotlarini yuklashda xatolik:', error);
            }
        }
        
        // 8. Texnik talablar jadvalini yangilash
        function updateTechTable() {
            const tableBody = document.getElementById('techTableBody');
            tableBody.innerHTML = '';
            
            if (roomDetails.length === 0) return;
            
            roomDetails.forEach(room => {
                const row = document.createElement('tr');
                
                const categoryCell = document.createElement('td');
                categoryCell.textContent = room.category_name || room.name;
                
                const lkCell = document.createElement('td');
                lkCell.textContent = room.lk;
                lkCell.id = 'lkValue';
                
                const raCell = document.createElement('td');
                raCell.textContent = room.ra || '85';
                
                const ugrCell = document.createElement('td');
                ugrCell.textContent = room.ugr || '24';
                
                row.appendChild(categoryCell);
                row.appendChild(lkCell);
                row.appendChild(raCell);
                row.appendChild(ugrCell);
                
                tableBody.appendChild(row);
                
                currentLk = room.lk || 0;
                document.getElementById('luxValue').textContent = currentLk;
            });
        }
        
        // 9. O'lchamni o'zgartirish
        function changeDimension(type, delta) {
            dimensions[type] = Math.max(1.0, Math.min(20.0, dimensions[type] + delta));
            dimensions[type] = Math.round(dimensions[type] * 10) / 10;
            
            document.getElementById(type).textContent = dimensions[type].toFixed(1);
            
            document.getElementById('dimTop').textContent = dimensions.height.toFixed(1) + ' m';
            document.getElementById('dimRight').textContent = dimensions.length.toFixed(1) + ' m';
            document.getElementById('dimBottom').textContent = dimensions.width.toFixed(1) + ' m';
            
            calculate();
            
            if (document.getElementById('roomType').value && document.getElementById('colorScheme').value) {
                calculateLamps();
            }
        }
        
        // 10. Asosiy hisoblash funksiyasi
        function calculate() {
            const area = dimensions.width * dimensions.length;
            const lumen = currentLk > 0 ? Math.round(area * currentLk * 1.3) : 0;
            
            document.getElementById('area').textContent = area.toFixed(2);
            document.getElementById('lumen').textContent = lumen.toLocaleString();
            
            if (currentLk > 0) {
                document.querySelector('.result-card.green .result-note').innerHTML = 
                    `<i class="bi bi-check-circle me-1"></i>Norma-min ${Math.round(area * currentLk)} lm`;
            }
        }
        // 11. Lampochkalarni hisoblash - TO'G'RILANGAN FUNKSIYA
        function calculateLamps() {
            // Barcha parametrlar tanlangani tekshirish
            const roomType = document.getElementById('roomType').value;
            const colorScheme = document.getElementById('colorScheme').value;
            const roomCleanliness = document.getElementById('roomCleanliness').value;
            
            if (!roomType || !colorScheme || !roomCleanliness || roomDetails.length === 0) {
                hideAIandRecommendation();
                document.getElementById('lightingInfoAlert').classList.remove('show');
                return;
            }
            
            // AI bo'limini ko'rsatish
            document.getElementById('aiSection').classList.add('show');
            
            // Boshlang'ich AI matnini ko'rsatish
            document.getElementById('aiAdvice').innerHTML = 
                "Xona parametrlari tahlil qilinmoqda. AI maslahatchi sizga eng yaxshi yoritish variantini tavsiya qiladi.";
            
            // Xona parametrlari
            const area = dimensions.width * dimensions.length;
            const lk = currentLk;
            
            // Eng yaqin indeksni topish (xona tozalik koeffitsienti)
            let closestIndex = lightIndices[0];
            const x = parseFloat(roomCleanliness); // xona tozalik koeffitsienti
            
            // Rang kombinatsiyasi uchun koeffitsientni topish
            let coefficient = 0.5;
            for (const indexData of lightIndices) {
                for (const koeff of indexData.koeffitsientlar) {
                    if (koeff.rang === colorScheme) {
                        coefficient = koeff.qiymat;
                        break;
                    }
                }
            }
            
            // HAR BIR KATEGORIYA UCHUN ALohida hisoblash
            calculatedLampsByCategory = {};
            let bestLampOverall = null;
            let minLampsOverall = Infinity;
            
            Object.keys(lampGroups).forEach(category => {
                const lampsInCategory = lampGroups[category];
                let bestLampInCategory = null;
                let minLampsInCategory = Infinity;
                
                lampsInCategory.forEach(lamp => {
                    const F = lamp.luminous_flux_max || 0;
                    if (F === 0) return;
                    
                    // TO'G'RI FORMULA: N = (s Ã— lk) / (ranglar koeffsenti Ã— lampochka lm Ã— X)
                    const n = Math.ceil((lk * area) / (coefficient * F * x));
                    
                    if (n < minLampsInCategory) {
                        minLampsInCategory = n;
                        bestLampInCategory = {
                            lamp: lamp,
                            count: n,
                            totalPower: (parseInt(lamp.power) || 0) * n,
                            cleanlinessCoefficient: x,
                            colorCoefficient: coefficient
                        };
                    }
                    
                    if (n < minLampsOverall) {
                        minLampsOverall = n;
                        bestLampOverall = {
                            lamp: lamp,
                            count: n,
                            totalPower: (parseInt(lamp.power) || 0) * n,
                            category: category,
                            cleanlinessCoefficient: x,
                            colorCoefficient: coefficient
                        };
                    }
                });
                
                if (bestLampInCategory) {
                    calculatedLampsByCategory[category] = bestLampInCategory;
                }
            });
            
            // Eng yaxshi lampochkani ko'rsatish
            if (bestLampOverall) {
                updateProductCard(bestLampOverall.lamp, bestLampOverall.count, bestLampOverall.cleanlinessCoefficient, bestLampOverall.colorCoefficient);
                
                // AI maslahatini animatsiya bilan ko'rsatish
                updateAIAdvice(bestLampOverall.lamp, bestLampOverall.count, bestLampOverall.cleanlinessCoefficient, bestLampOverall.colorCoefficient);
                
                updateCategoryLampsTable();
            }
        } 

        
        
        // 12. Mahsulot kartasini yangilash (to'g'rilangan)
        function updateProductCard(lamp, count, cleanlinessCoefficient, colorCoefficient) {
            document.getElementById('productImage').src = lamp.image || 'https://via.placeholder.com/110x110?text=No+Image';
            document.getElementById('productImage').alt = lamp.name;
            document.getElementById('productTitle').textContent = lamp.name || 'LED Lampa';
            document.getElementById('lightingInfoAlert').classList.add('show');
            // Koeffitsientlarni hisobga olgan holda tavsiya
            let cleanlinessText = '';
            let colorText = '';
            
            switch(cleanlinessCoefficient) {
                case 1.25:
                    cleanlinessText = 'Juda toza xona';
                    break;
                case 1.5:
                    cleanlinessText = 'Toza xona';
                    break;
                case 1.75:
                    cleanlinessText = 'O\'rtacha toza xona';
                    break;
                case 2:
                    cleanlinessText = 'Toza bo\'lmagan xona';
                    break;
                default:
                    cleanlinessText = 'Xona';
            }
            
            // Rang kombinatsiyasini aniqlash
            const colorScheme = document.getElementById('colorScheme').value;
            switch(colorScheme) {
                case '80/80/30':
                    colorText = 'Juda och ranglar';
                    break;
                case '80/50/30':
                    colorText = 'Och ranglar';
                    break;
                case '70/50/20':
                    colorText = 'O\'rtacha och ranglar';
                    break;
                case '50/50/10':
                    colorText = 'O\'rtacha ranglar';
                    break;
                case '50/30/10':
                    colorText = 'Kulrang / qorong\'i kulrang';
                    break;
                case '30/30/10':
                    colorText = 'Qorong\'i ranglar';
                    break;
                case '0/0/0':
                    colorText = 'Juda qorong\'i';
                    break;
                default:
                    colorText = '';
            }
            
            document.getElementById('productDesc').textContent = 
                `${cleanlinessText}, ${colorText} uchun eng optimal variant.`;
            
            document.getElementById('requiredCount').textContent = `${count} ta`;
            
            const powerPerLamp = parseInt(lamp.power) || 0;
            const totalPower = powerPerLamp * count;
            document.getElementById('totalPower').textContent = `${totalPower}W`;
        }
        // 13. AI maslahatini yangilash (to'g'rilangan)
        // AI javobini animatsiya bilan chiqarish funksiyasi
        function typeWriter(text, elementId, speed = 30) {
            const element = document.getElementById(elementId);
            element.innerHTML = '';
            let i = 0;
            
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                }
            }
            type();
        }
        // AI maslahatchiga so'rov yuborish funksiyasi
        async function getAIAdvice(data) {
            try {
                const response = await fetch('https://cal.tmsiti.uz/api/v1/lightbulb/lighting/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        "X-CSRFToken": getCookie("csrftoken")
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP xatosi! Status: ${response.status}`);
                }
                
                const result = await response.json();
                return result.recommendation || "Maslahat mavjud emas";
            } catch (error) {
                console.error('AI maslahatchidan javob olishda xatolik:', error);
                return "AI maslahatchi bilan bog'lanishda xatolik yuz berdi. Iltimos, qayta urinib ko'ring.";
            }
        }

        // AI tavsiyalarini yangilash (to'g'rilangan va animatsiya qo'shilgan)
        async function updateAIAdvice(lamp, count, cleanlinessCoefficient, colorCoefficient) {
            const powerPerLamp = parseInt(lamp.power) || 0;
            const totalPower = powerPerLamp * count;
            const flux = lamp.luminous_flux_max || 0;
            
            // AI ga yuboriladigan ma'lumotlar
            const aiData = {
                "width": dimensions.width,
                "length": dimensions.length,
                "height": dimensions.height,
                "reflectance": document.getElementById('colorScheme').value || "70/50/20",
                "required_lux": currentLk || 150,
                "room_type": document.getElementById('roomType').options[document.getElementById('roomType').selectedIndex]?.text || "turar joy xonasi"
            };
            
            // AI javobini so'rash
            const aiMessage = await getAIAdvice(aiData);
            
            // Animatsiya boshlash uchun loading holati
            const aiAdviceElement = document.getElementById('aiAdvice');
            aiAdviceElement.innerHTML = '<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>';
            
            // 1.5 soniya kutib, keyin animatsiya bilan chiqarish
            setTimeout(() => {
                typeWriter(aiMessage, 'aiAdvice', 20);
            }, 1500);
            
            // Tejamkorlikni baholash
            let efficiency = "O'rtacha";
            if (powerPerLamp <= 15) efficiency = "Yuqori tejamkor";
            else if (powerPerLamp <= 30) efficiency = "Tejamkor";
            else if (powerPerLamp <= 50) efficiency = "O'rtacha";
            else efficiency = "Ko'p quvvat";
            
            // Yorug'lik darajasi
            let brightnessLevel = "O'rtacha";
            if (flux >= 3000) brightnessLevel = "Yuqori";
            else if (flux >= 1500) brightnessLevel = "Yaxshi";
            else brightnessLevel = "Past";
            
            document.getElementById('efficiencyTag').textContent = `Tejamkorlik: ${efficiency}`;
            document.getElementById('brightnessTag').textContent = `Yorug'lik: ${brightnessLevel}`;
        }
        function updateCategoryLampsTable() {
            const tableBody = document.getElementById('categoryLampsBody');
            tableBody.innerHTML = '';
            
            let rowCount = 0;
            
            Object.keys(calculatedLampsByCategory).forEach(category => {
                const lampData = calculatedLampsByCategory[category];
                const lamp = lampData.lamp;
                const count = lampData.count;
                const powerPerLamp = parseInt(lamp.power) || 0;
                const totalPower = powerPerLamp * count;
                const cleanliness = lampData.cleanlinessCoefficient || 1.5;
                const colorCoeff = lampData.colorCoefficient || 0.5;
                
                const row = document.createElement('tr');
                
                // Rasmi
                const imgCell = document.createElement('td');
                if (lamp.image) {
                    const img = document.createElement('img');
                    img.src = lamp.image;
                    img.alt = lamp.name;
                    img.className = 'category-image';
                    imgCell.appendChild(img);
                } else {
                    imgCell.textContent = '-';
                }
                
                // Nomi
                const nameCell = document.createElement('td');
                nameCell.textContent = lamp.name || '-';
                
                // Kategoriya
                const categoryCell = document.createElement('td');
                categoryCell.textContent = category;
                
                // Kerakli soni
                const countCell = document.createElement('td');
                countCell.innerHTML = `<strong>${count} ta</strong>`;
                
                // Quvvat (bitta)
                const powerCell = document.createElement('td');
                powerCell.textContent = `${powerPerLamp}W`;
                
                // Jami quvvat
                const totalPowerCell = document.createElement('td');
                totalPowerCell.innerHTML = `<strong>${totalPower}W</strong>`;
                
                row.appendChild(imgCell);
                row.appendChild(nameCell);
                row.appendChild(categoryCell);
                row.appendChild(countCell);
                row.appendChild(powerCell);
                row.appendChild(totalPowerCell);
                
                tableBody.appendChild(row);
                rowCount++;
            });
            
            // Jadval sarlavhasini yangilash
            const cleanliness = document.getElementById('roomCleanliness').value;
            let cleanlinessText = '';
            switch(cleanliness) {
                case '1.25': cleanlinessText = 'Juda toza xona'; break;
                case '1.5': cleanlinessText = 'Toza xona'; break;
                case '1.75': cleanlinessText = 'O\'rtacha toza'; break;
                case '2': cleanlinessText = 'Toza emas'; break;
                default: cleanlinessText = '';
            }
            
            document.getElementById('categoryLampsTitle').textContent = 
                `Barcha lampochka turlari (${rowCount} ta kategoriya) - ${cleanlinessText}`;
            
            // Agar hech narsa bo'lmasa
            if (rowCount === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            Iltimos, xona tozaligi va rang kombinatsiyasini tanlang
                        </td>
                    </tr>
                `;
            }
        }
        // 15. Kategoriya lampochkalarini ko'rsatish/yashirish
        function toggleCategoryLamps() {
            const section = document.getElementById('categoryLampsSection');
            const toggleBtn = document.querySelector('.details-toggle span:first-child');
            
            if (section.classList.contains('show')) {
                section.classList.remove('show');
                toggleBtn.textContent = 'Barcha lampochka turlarini ko\'rish';
            } else {
                section.classList.add('show');
                toggleBtn.textContent = 'Lampochka turlarini yashirish';
                
                // Jadvalni yangilash
                updateCategoryLampsTable();
            }
        }
        
        // 16. Lampochka turi bo'yicha jadvallash
        function showLampsByType(type) {
            selectedLampType = type;
            
            document.querySelectorAll('.light-card').forEach(card => {
                card.classList.remove('active');
            });
            
            event.currentTarget.classList.add('active');
            
            const lampsInGroup = lampGroups[type] || [];
            
            const sortedLamps = [...lampsInGroup].sort((a, b) => {
                const powerA = parseInt(a.power) || 0;
                const powerB = parseInt(b.power) || 0;
                return powerA - powerB;
            });
            
            populateLampsTable(sortedLamps, type);
        }
        
        // 17. Lampochkalar jadvalini to'ldirish
        function populateLampsTable(filteredLamps, type) {
            const tableBody = document.getElementById('lampsTableBody');
            tableBody.innerHTML = '';
            
            if (filteredLamps.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            Ushbu turdagi lampochkalar topilmadi
                        </td>
                    </tr>
                `;
            } else {
                filteredLamps.forEach(lamp => {
                    const row = document.createElement('tr');
                    
                    const imgCell = document.createElement('td');
                    if (lamp.image) {
                        const img = document.createElement('img');
                        img.src = lamp.image;
                        img.alt = lamp.name;
                        img.className = 'lamp-image';
                        imgCell.appendChild(img);
                    } else {
                        imgCell.textContent = '-';
                    }
                    
                    const nameCell = document.createElement('td');
                    nameCell.textContent = lamp.name || '-';
                    
                    const powerCell = document.createElement('td');
                    powerCell.textContent = lamp.power ? `${lamp.power} W` : '-';
                    
                    const fluxCell = document.createElement('td');
                    fluxCell.textContent = lamp.luminous_flux || '-';
                    
                    const dimensionsCell = document.createElement('td');
                    dimensionsCell.textContent = lamp.dimensions || '-';
                    
                    row.appendChild(imgCell);
                    row.appendChild(nameCell);
                    row.appendChild(powerCell);
                    row.appendChild(fluxCell);
                    row.appendChild(dimensionsCell);
                    
                    tableBody.appendChild(row);
                });
            }
            
            document.getElementById('lampsTableTitle').textContent = `${type} lampochkalari (${filteredLamps.length} ta)`;
            document.getElementById('lampsTableContainer').style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('lampsTableContainer').scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 100);
        }
        
        // 18. Texnik jadvalni tozalash
        function clearTechTable() {
            const tableBody = document.getElementById('techTableBody');
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Bino va xona turini tanlang</td></tr>';
            currentLk = 0;
            document.getElementById('luxValue').textContent = '---';
        }
        
        // 19. Yorug'lik oqimini nolga qaytarish (o'zgartirilgan)
        function resetLumen() {
            document.getElementById('lumen').textContent = '0';
            document.querySelector('.result-card.green .result-note').innerHTML = 
                '<i class="bi bi-check-circle me-1"></i>Bino va xona turini tanlang';
            
            // Xona tozalik koeffitsientini ham reset qilish
            document.getElementById('roomCleanliness').selectedIndex = 0;
            document.getElementById('colorScheme').selectedIndex = 0;
        }

        // 20. AI va tavsiya bo'limlarini yashirish (o'zgartirilgan)
        function hideAIandRecommendation() {
            toggleAISection(false);
            document.getElementById('lightingInfoAlert').classList.remove('show');
            document.getElementById('categoryLampsSection').classList.remove('show');
            document.getElementById('lampsTableContainer').style.display = 'none';
            
            // Tozalik koeffitsientiga mos ravishda xabarlar
            document.querySelectorAll('.light-card').forEach(card => {
                card.classList.remove('active');
            });
        }

        // 21. Qoshimcha variantlarni ko'rsatish (o'zgartirilgan)
        function showAlternativeVariants() {
            const cleanliness = document.getElementById('roomCleanliness').value;
            const colorScheme = document.getElementById('colorScheme').value;
            
            if (!cleanliness || !colorScheme) {
                alert("Iltimos, avval xona tozaligi va rang kombinatsiyasini tanlang!");
                return;
            }
            
            // Tozalik darajasi bo'yicha qo'shimcha maslahatlar
            let advice = '';
            switch(cleanliness) {
                case '1.25':
                    advice = 'Juda toza xonalar uchun past quvvatli, ammo yuqori samarali lampochkalarni tanlang.';
                    break;
                case '1.5':
                    advice = 'Toza xonalar uchun standart LED lampochkalar yetarli bo\'ladi.';
                    break;
                case '1.75':
                    advice = 'O\'rtacha tozalikdagi xonalar uchun qo\'shimcha yorug\'lik beradigan lampochkalarni tanlang.';
                    break;
                case '2':
                    advice = 'Toza bo\'lmagan xonalar uchun kuchliroq va changga chidamli lampochkalar tavsiya etiladi.';
                    break;
            }
            
            alert(`Boshqa variantlar:\n\n${advice}\n\nTozalik koeffitsienti: ${cleanliness}\nRang kombinatsiyasi: ${colorScheme}`);
        }
        
        // 22. Qadamlar uchun bosish qobiliyati
        document.querySelectorAll('.step-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.step-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
            });
        });
        
        // Boshlang'ich hisoblash
        calculate();
    </script>
</body>
</html>