      // Materiallar JSON ma'lumotlari
        const materialData = [
  {
    "category_name": "Бетонлар ва қоришмалар",
    "subcategories": [
      {
        "subcategory": "Табний зич тўлдиргичлардаги бетонлар",
        "items": [
          {
            "name": "Темирбетон",
            "l": 1.92
          },
          {
            "name": "Табиий тошдан иборат бўлган чақиқ тош ёқи шағал асосидаги бетон",
            "l": 1.74
          }
        ]
      },
      {
        "subcategory": "Ячейкали бетон",
        "items": [
          {
            "name": "Газ- ва кўпик-бетон, газ- ва кўпик-силикат бетон-1000",
            "l": 0.41
          },
          {
            "name": "Газ- ва кўпик-бетон, газ- ва кўпик-силикат бетон-800",
            "l": 0.33
          },
          {
            "name": "Газ- ва кўпик-бетон, газ- ва кўпик-силикат бетон-600",
            "l": 0.22
          },
          {
            "name": "Газ- ва кўпик-бетон, газ- ва кўпик-силикат бетон-400",
            "l": 0.14
          },
          {
            "name": "Газ- ва кўпик-бетон, газ- ва кўпик-силикат бетон-300",
            "l": 0.11
          },
          {
            "name": "Газ- ва кўпик-бетон, газ- ва кўпик-силикат бетон-1200",
            "l": 0.52
          }
        ]
      },
      {
        "subcategory": "Цементли, оҳакли ва гипсли қоришмалар",
        "items": [
          {
            "name": "Цемент-қумли",
            "l": 0.76
          },
          {
            "name": "Мураккаб (кум, оҳак, цемент)",
            "l": 0.7
          },
          {
            "name": "Оҳак-қумли",
            "l": 0.7
          },
          {
            "name": "Цемент-шлакли-1400",
            "l": 0.52
          },
          {
            "name": "Цемент-шлакли-1200",
            "l": 0.47
          },
          {
            "name": "Цемент-перлитли-1000",
            "l": 0.26
          },
          {
            "name": "Цемент-перлитли-800",
            "l": 0.21
          },
          {
            "name": "Гипс-перлитли",
            "l": 0.19
          },
          {
            "name": "Ғоваклантирилган гипс-перлитли-500",
            "l": 0.15
          },
          {
            "name": "Ғоваклантирилган гипс-перлитли-400",
            "l": 0.13
          },
          {
            "name": "Гипсли плиталар-1200",
            "l": 0.41
          },
          {
            "name": "Гипсли плиталар-1000",
            "l": 0.29
          },
          {
            "name": "Гипсли плиталар-1100",
            "l": 0.35
          },
          {
            "name": "Гипсли плиталар-1350",
            "l": 0.5
          },
          {
            "name": "Гипс қопламали листлар (қуруқ сувоқ)-800",
            "l": 0.19
          },
          {
            "name": "Гипс қопламали листлар (қуруқ сувоқ)-1050",
            "l": 0.34
          }
        ]
      }
    ]
  },
  {
    "category_name": "Табиий тошдан қоплама қилиш ва ғишт териш",
    "subcategories": [
      {
        "subcategory": "Яхлит ғиштдан ғишт териш",
        "items": [
          {
            "name": "Цемент-шлакли қоришмада оддий гилли (ГОСТ 530-80)-1800",
            "l": 0.7
          },
          {
            "name": "Цемент-шлакли қоришмада оддий гилли-1700",
            "l": 0.64
          },
          {
            "name": "Цемент-перлитли қоришмада оддий гилли-1600",
            "l": 0.58
          },
          {
            "name": "Цемент-қумли қоришмада силикатли (ГОСТ 379-79)-1800",
            "l": 0.76
          },
          {
            "name": "Цемент-қумли қоришмада трепелли (ГОСТ 648-73)-1200",
            "l": 0.47
          },
          {
            "name": "Цемент-қумли қоришмада трепелли-1000",
            "l": 0.41
          },
          {
            "name": "Цемент-қумли қоришмада шлакли-1500",
            "l": 0.64
          }
        ]
      },
      {
        "subcategory": "Керамика ва силикатли ичи бўш ғиштдан ғишт териш",
        "items": [
          {
            "name": "Цемент-қумли қоришмада зичлиги 1400 кг/м3 (брутто) ичи бўш керамикали",
            "l": 0.58
          },
          {
            "name": "Цемент-қумли қоришмада зичлиги 1300 кг/м3 (брутто) ичи бўш керамикали",
            "l": 0.52
          },
          {
            "name": "Цемент-қумли қоришмада зичлиги 1000 кг/м3 (брутто) ичи бўш керамикали",
            "l": 0.47
          },
          {
            "name": "Цемент-қумли қоришмада ўн бир қовакли силикатли-1500",
            "l": 0.7
          },
          {
            "name": "Цемент-қумли қоришмада ўн тўрт қовакли силикатли-1400",
            "l": 0.64
          }
        ]
      }
    ]
  },
  {
    "category_name": "Ёғоч, узндан ва бошқа табиий органиқ материаллардан тайёрланган буюмлар",
    "subcategories": [
      {
        "subcategory": "Ёғоч, узндан ва бошқа табиий органиқ материаллардан тайёрланган буюмлар",
        "items": [
          {
            "name": "Қарағай ва толаларига кўндаланг қорақарағай (ГОСТ 8486-66**, ГОСТ 9463-72)",
            "l": 0.14
          },
          {
            "name": "Қарағай ва толалари бўйича бўлган қорақарағай",
            "l": 0.29
          },
          {
            "name": "Толаларига кўндаланг дуб (ГОСТ 9462-71*,",
            "l": 0.18
          },
          {
            "name": "Толалаи бўйича дуб",
            "l": 0.35
          },
          {
            "name": "Елимланган фанера",
            "l": 0.15
          },
          {
            "name": "Қопламали картон",
            "l": 0.21
          },
          {
            "name": "Қўп қаватли",
            "l": 0.15
          },
          {
            "name": "Ёғоч толали ва ёғоч қипигли плиталар (ДСП) (ГОСТ 4598-74*,",
            "l": 0.23
          }
        ]
      }
    ]
  },
  {
    "category_name": "Иссиқликни изоляцияловчи материаллар",
    "subcategories": [
      {
        "subcategory": "Минерал мамиқли ва шиша толали минерал момиқли бордонлар (матлар)",
        "items": [
          {
            "name": "Синтетик боғловчи асосидағи (ГОСТ 9573-82) ва тиқилган минерал момиқли бордонлар (матлар) (ГОСТ 21880-76)-125",
            "l": 0.064
          },
          {
            "name": "Синтетик боғловчи асосидағи (ГОСТ 9573-82) ва тиқилган минерал момиқли бордонлар (матлар) (ГОСТ 21880-76)-125",
            "l": 0.061
          },
          {
            "name": "Синтетик боғловчи асосидағи (ГОСТ 9573-82) ва тиқилган минерал момиқли бордонлар (матлар) (ГОСТ 21880-76)-100",
            "l": 0.06
          },
          {
            "name": "Синтетик боғловчи асосидағи (ГОСТ 9573-82) ва тиқилган минерал момиқли бордонлар (матлар) (ГОСТ 21880-76)-75",
            "l": 0.052
          },
          {
            "name": "Синтетик боғловчи асосидағи минерал момиқли бордонлар (матлар)-225",
            "l": 0.072
          },
          {
            "name": "Синтетик боғловчи асосидағи минерал момиқли бордонлар (матлар)-175",
            "l": 0.066
          },
          {
            "name": "Синтетик боғловчи асосидағи минерал момиқли бордонлар (матлар)-125",
            "l": 0.064
          },
          {
            "name": "Синтетик боғловчи асосидағи минерал момиқли бордонлар (матлар)-75",
            "l": 0.058
          },
          {
            "name": "Битумли боғловчи ва синтетик асосидаги",
            "l": 0.09
          }
        ]
      },
      {
        "subcategory": "Полимерли",
        "items": [
          {
            "name": "Пенополистирол",
            "l": 0.052
          }
        ]
      },
      {
        "subcategory": "Пенополистирол 2500С-да",
        "items": [
          {
            "name": "Пенополистирол 2800С-да",
            "l": 0.031
          },
          {
            "name": "Пенополистирол 3035С-да",
            "l": 0.031
          },
          {
            "name": "Пенополистирол 4000С-да",
            "l": 0.031
          },
          {
            "name": "Пенополистирол 5000С-да",
            "l": 0.031
          },
          {
            "name": "Пенополистирол РS15",
            "l": 0.04
          },
          {
            "name": "Пенополистирол РS20",
            "l": 0.038
          },
          {
            "name": "Пенополистирол РS30",
            "l": 0.036
          },
          {
            "name": "Экструзияланган",
            "l": 0.03
          }
        ]
      },
      {
        "subcategory": "Кўпик шиша ёки газ шиша",
        "items": [
          {
            "name": "Кўпик шиша ёки газ шиша (ТУ 21-БССР-86-73)-400",
            "l": 400
          },
          {
            "name": "Кўпик шиша ёки газ шиша (ТУ 21-БССР-86-73)-300",
            "l": 300
          },
          {
            "name": "Кўпик шиша ёки газ шиша (ТУ 21-БССР-86-73)-200",
            "l": 200
          }
        ]
      }
    ]
  },
  {
    "category_name": "Поллар учун рулонли, қопламали, гидроизоляцицияли ва томга оид материаллар",
    "subcategories": [
      {
        "subcategory": "Асбест-цементли",
        "items": [
          {
            "name": "Юпқа асбест-цементли листлар (тахталар) (ГОСТ 18124-75*)-1800",
            "l": 0.47
          },
          {
            "name": "Юпқа асбест-цементли листлар (тахталар) (ГОСТ 18124-75*)-1600",
            "l": 0.35
          },
          {
            "name": "Қурилишга ва томга оид нефт битумлари (ГОСТ 6617-76*, ГОСТ 9548-74*)-1400",
            "l": 0.27
          },
          {
            "name": "Қурилишга ва томга оид нефт битумлари (ГОСТ 6617-76*, ГОСТ 9548-74*)-1200",
            "l": 0.22
          },
          {
            "name": "Қурилишга ва томга оид нефт битумлари (ГОСТ 6617-76*, ГОСТ 9548-74*)-1000",
            "l": 0.17
          },
          {
            "name": "Асфальт-бетон (ГОСТ 9128-84)",
            "l": 1.05
          },
          {
            "name": "Битумли боғловчи асосдаги шиширилган перлитдан иборат буюмлар (ГОСТ 16136-80)",
            "l": 0.12
          },
          {
            "name": "Битум боғловчили шиширилган перлитдан буюмлар",
            "l": 0.09
          }
        ]
      },
      {
        "subcategory": "Линолеумлар",
        "items": [
          {
            "name": "Кўп қаватли поливинилхлоридли линолеум (ГОСТ 14632-79)-1800",
            "l": 0.38
          },
          {
            "name": "Кўп қаватли поливинилхлоридли линолеум (ГОСТ 14632-79)-1600",
            "l": 0.33
          },
          {
            "name": "Мато асоидаги поливинилхлоридли линолеум (ГОСТ 7251-77)-1800",
            "l": 0.35
          },
          {
            "name": "Мато асоидаги поливинилхлоридли линолеум (ГОСТ 7251-77)-1600",
            "l": 0.29
          },
          {
            "name": "Мато асоидаги поливинилхлоридли линолеум (ГОСТ 7251-77)-1400",
            "l": 0.29
          },
          {
            "name": "Мато асоидаги поливинилхлоридли линолеум (ГОСТ 7251-77)-1200",
            "l": 0.23
          }
        ]
      }
    ]
  },
  {
    "category_name": "Металлар ва шиша",
    "subcategories": [
      {
        "subcategory": "Металлар ва шиша",
        "items": [
          {
            "name": "Стерженли арматурали пўлат (ГОСТ 10884-81)",
            "l": 58
          },
          {
            "name": "Чўян",
            "l": 50
          },
          {
            "name": "Алюминий (ГОСТ 22233-83)",
            "l": 221
          },
          {
            "name": "Мис (ГОСТ 859-78*)",
            "l": 407
          },
          {
            "name": "Ойнага оид шиша (ГОСТ 111-78)",
            "l": 0.76
          }
        ]
      }
    ]
  }
        ];

        // Global o'zgaruvchilar
        let regionsData = [];
        let selectedRegionData = null;
        let selectedDistrictData = null;
        let baseTemperature = 20;
        
        // Materiallar tizimi uchun global o'zgaruvchilar
        let currentSection = null;
        let selectedMaterial = null;
        let wallLayers = [];
        let floorLayers = [];
        let ceilingLayers = [];

        // DOM yuklanganda bajariladigan funksiyalar
        document.addEventListener('DOMContentLoaded', function() {
            // API dan viloyatlarni yuklash
            loadRegionsFromAPI();
            
            // Bino turi tanlanganda "Boshqa" tanlansa, qo'shimcha maydon ko'rsatish
            document.getElementById('buildingType').addEventListener('change', function() {
                const otherBuildingType = document.getElementById('otherBuildingType');
                if (this.value === 'boshqa') {
                    otherBuildingType.style.display = 'block';
                } else {
                    otherBuildingType.style.display = 'none';
                }
                
                // Baza haroratini yangilash
                const selectedOption = this.options[this.selectedIndex];
                baseTemperature = parseFloat(selectedOption.getAttribute('data-base-temp')) || 20;
                
                // Hudud ma'lumotlarini yangilash
                if (selectedDistrictData) {
                    displayRegionInfo();
                }
            });
            
            // Xona o'lchamlari o'zgarganda yuzalarni hisoblash
            const dimensionInputs = document.querySelectorAll('.dimension-input');
            dimensionInputs.forEach(input => {
                input.addEventListener('input', calculateAreas);
            });
            
            // Bosqichlar navigatsiyasi
            const steps = document.querySelectorAll('.step');
            const formSections = document.querySelectorAll('.form-section');
            
            // Bosqichlarga bosganda o'tish
            steps.forEach(step => {
                step.addEventListener('click', function() {
                    const stepNumber = this.getAttribute('data-step');
                    goToStep(stepNumber);
                });
            });
            
            // Keyingi bosqich tugmasi
            document.querySelectorAll('.next-step').forEach(button => {
                button.addEventListener('click', function() {
                    const nextStep = this.getAttribute('data-next');
                    goToStep(nextStep);
                });
            });
            
            // Oldingi bosqich tugmasi
            document.querySelectorAll('.prev-step').forEach(button => {
                button.addEventListener('click', function() {
                    const prevStep = this.getAttribute('data-prev');
                    goToStep(prevStep);
                });
            });
            
            // Eshik qo'shish
            let doorCount = 0;
            document.getElementById('addDoor').addEventListener('click', function() {
                doorCount++;
                addDoorItem(doorCount);
            });
            
            // Deraza qo'shish
            let windowCount = 0;
            document.getElementById('addWindow').addEventListener('click', function() {
                windowCount++;
                addWindowItem(windowCount);
            });
            
            // Hisoblash tugmasi
            document.getElementById('calculateBtn').addEventListener('click', function() {
                calculateHeating();
                setTimeout(calculateHeaters, 100);
            });
            
            // Dastlabki yuzalarni hisoblash
            calculateAreas();
            
            // Dastlabki bir eshik va deraza qo'shish
            addDoorItem(1);
            addWindowItem(1);
            
            // Material tanlash tugmalari
            document.getElementById('wallMaterialBtn').addEventListener('click', function() {
                openMaterialModal('wall');
            });
            
            document.getElementById('floorMaterialBtn').addEventListener('click', function() {
                openMaterialModal('floor');
            });
            
            document.getElementById('ceilingMaterialBtn').addEventListener('click', function() {
                openMaterialModal('ceiling');
            });
            
            // Modal elementlari
            const materialModal = new bootstrap.Modal(document.getElementById('materialModal'));
            const materialSearch = document.getElementById('materialSearch');
            const categorySelect = document.getElementById('categorySelect');
            const materialList = document.getElementById('materialList');
            const selectMaterialBtn = document.getElementById('selectMaterial');
            const clearSearchBtn = document.getElementById('clearSearch');
            
            // Kategoriyalarni yuklash
            populateCategories();
            
            // Material ro'yxatini yuklash
            loadMaterialList(materialData);
            
            // Material qidirish
            materialSearch.addEventListener('input', function() {
                filterMaterials();
            });
            
            // Kategoriya tanlash
            categorySelect.addEventListener('change', function() {
                filterMaterials();
            });
            
            // Qidiruvni tozalash
            clearSearchBtn.addEventListener('click', function() {
                materialSearch.value = '';
                filterMaterials();
            });
            
            // Material tanlash
            selectMaterialBtn.addEventListener('click', function() {
                if (selectedMaterial && currentSection) {
                    addMaterialToSection(currentSection, selectedMaterial);
                    materialModal.hide();
                }
            });
            
            // Modal ochilganda
            document.getElementById('materialModal').addEventListener('show.bs.modal', function() {
                materialSearch.value = '';
                categorySelect.value = '';
                selectedMaterial = null;
                loadMaterialList(materialData);
            });
        });

        // ========== YANGI FUNKSIYALAR ==========

        // 1. Umumiy Issiqlik (Qum) avtomatik hisoblash
        function calculateQForSection(section, resistance) {
            if (!selectedDistrictData || resistance === 0) return;
            
            const tempDifference = baseTemperature - selectedDistrictData.average_temperature;
            const time = selectedDistrictData.time;
            
            let area = 0;
            let qDisplayId = '';
            
            if (section === 'wall') {
                area = parseFloat(document.getElementById('finalWallArea').textContent) || 0;
                qDisplayId = 'wallTotalQ';
            } else if (section === 'floor') {
                area = parseFloat(document.getElementById('floorArea').value) || 0;
                qDisplayId = 'floorTotalQ';
            } else if (section === 'ceiling') {
                area = parseFloat(document.getElementById('ceilingArea').value) || 0;
                qDisplayId = 'ceilingTotalQ';
            }
            
            // Q = (1/R) * (t_ichki - t_tashqi) * vaqt * 24 * yuzasi / 1000
            const Q = (1 / resistance) * tempDifference * time * 24 * area / 1000;
            
            document.getElementById(qDisplayId).textContent = Q.toFixed(2);
        }

        // 2. Qarshilik cheklovi va ogohlantirish
// 2. Qarshilik cheklovi va ogohlantirish
function checkResistanceLimits(section, resistance) {
    // Har bir konstruksiya uchun alohida minimal qarshiliklar
    const minResistances = {
        'wall': 2.2,     // Devor uchun 2.2 m²·°C/W
        'floor': 2.8,    // Pol uchun 3.2 m²·°C/W
        'ceiling': 3.7   // Tom uchun 3.7 m²·°C/W
    };
    
    const minResistance = minResistances[section];
    const warningElements = {
        'wall': 'wallResistanceWarning',
        'floor': 'floorResistanceWarning', 
        'ceiling': 'ceilingResistanceWarning'
    };
    
    let warningElement = document.getElementById(warningElements[section]);
    
    // Agar ogohlantirish elementi mavjud bo'lmasa, yaratamiz
    if (!warningElement) {
        const resistanceDisplay = document.getElementById(`${section}ResistanceDisplay`);
        warningElement = document.createElement('div');
        warningElement.id = warningElements[section];
        warningElement.className = 'alert alert-warning mt-2';
        warningElement.style.display = 'none';
        resistanceDisplay.parentNode.insertBefore(warningElement, resistanceDisplay.nextSibling);
    }
    
    // Qarshilikni tekshirish
    if (resistance < minResistance && resistance > 0) {
        const sectionName = section === 'wall' ? 'Devor' : section === 'floor' ? 'Pol' : 'Tom';
        warningElement.innerHTML = `
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Diqqat!</strong> ${sectionName} uchun qarshilik (${resistance.toFixed(3)} m²·°C/W) 
            talab qilinadigan minimal qarshilikdan (${minResistance} m²·°C/W) past.
            Issiqlik izolyatsiyasini kuchaytirish tavsiya etiladi.
        `;
        warningElement.style.display = 'block';
    } else {
        warningElement.style.display = 'none';
    }
}

        // 3. Isitish radiatorlari sonini hisoblash
        function calculateHeaters() {
            const totalQ = parseFloat(document.getElementById('resultTotalQ').textContent) || 0;
            const totalWindows = document.querySelectorAll('.window-item').length || 1;
            
            // Har bir deraza uchun issiqlik talabi
            const heatPerWindow = totalQ / totalWindows;
            
            // Radiator turlari
            const heaterTypes = {
                'aluminum': 619200,   // Vt/soat
                'cast_iron': 90300  // Vt/soat  
            };
            
            let heaterResults = '';
            
            for (const [type, power] of Object.entries(heaterTypes)) {
                const heatersNeeded = Math.ceil(heatPerWindow * 1000 / power);
                const typeName = type === 'aluminum' ? 'Alyuminiy' : 'Chugun';
                
                heaterResults += `
                    <div class="heater-type">
                        <h6>${typeName} radiatorlar (${power} W/yillik)</h6>
                        <p>Har bir deraza uchun: <span class="heater-count">${heatersNeeded} ta radiator</span></p>
                        <p>Jami: <span class="heater-count">${heatersNeeded * totalWindows} ta radiator</span></p>
                        <small>Har bir radiator: ${power} Vt quvvat</small>
                    </div>
                `;
            }
            
            // Natijalarni ko'rsatish
            const heaterSection = document.createElement('div');
            heaterSection.id = 'heaterResults';
            heaterSection.innerHTML = `
                <hr>
                <h5 class="text-primary">Isitish Radiatorlari Hisobi</h5>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Umumiy issiqlik yo'qotilishi:</strong> ${totalQ.toFixed(2)} kW h/m²y</p>
                        <p><strong>Derazalar soni:</strong> ${totalWindows} ta</p>
                        <p><strong>Har bir deraza uchun issiqlik:</strong> ${heatPerWindow.toFixed(2)} kW</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        ${heaterResults}
                    </div>
                </div>
            `;
            
            // Eskisi bo'lsa olib tashlaymiz
            const existingHeaterSection = document.getElementById('heaterResults');
            if (existingHeaterSection) {
                existingHeaterSection.remove();
            }
            
            // Yangi natijani qo'shamiz
            document.getElementById('calculationResult').appendChild(heaterSection);
        }

        // ========== MAVJUD FUNKSIYALARNI YANGILASH ==========

        // Qarshilikni hisoblash va yangilash (YANGILANGAN)
        function updateResistance(section) {
            let layers, resistanceDisplayId, qDisplayId;
            
            if (section === 'wall') {
                layers = wallLayers;
                resistanceDisplayId = 'wallTotalResistance';
                qDisplayId = 'wallTotalQ';
            } else if (section === 'floor') {
                layers = floorLayers;
                resistanceDisplayId = 'floorTotalResistance';
                qDisplayId = 'floorTotalQ';
            } else if (section === 'ceiling') {
                layers = ceilingLayers;
                resistanceDisplayId = 'ceilingTotalResistance';
                qDisplayId = 'ceilingTotalQ';
            }
            
            let totalResistance = 0;
            layers.forEach(layer => {
                if (layer.thickness > 0 && layer.l > 0) {
                    totalResistance += layer.thickness / layer.l;
                }
            });
            
            document.getElementById(resistanceDisplayId).textContent = totalResistance.toFixed(3);
            
            // Qarshilik cheklovini tekshirish (YANGI QO'SHILGAN)
            if (section !== 'door' && section !== 'window') {
                checkResistanceLimits(section, totalResistance);
            }
            
            // Q ni avtomatik hisoblash (YANGI QO'SHILGAN)
            calculateQForSection(section, totalResistance);
        }

        // Eshik qo'shish (YANGILANGAN)
        function addDoorItem(id) {
            const container = document.getElementById('doorsContainer');
            const doorItem = document.createElement('div');
            doorItem.className = 'door-window-item door-item';
            doorItem.innerHTML = `
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Eshik ${id} eni (m)</label>
                        <div class="input-group">
                            <input type="number" class="form-control door-width" min="0" step="0.01" value="0.9">
                            <span class="input-group-text">m</span>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Eshik ${id} balandligi (m)</label>
                        <div class="input-group">
                            <input type="number" class="form-control door-height" min="0" step="0.01" value="2.1">
                            <span class="input-group-text">m</span>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label class="form-label">Soni</label>
                        <div class="counter-input">
                            <div class="counter-btn minus-btn">-</div>
                            <div class="counter-value">1</div>
                            <div class="counter-btn plus-btn">+</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Eshik ${id} materiali</label>
                        <select class="form-select door-material">
                            <option value="yog'och">Yog'och</option>
                            <option value="metall">Metall</option>
                            <option value="plastik">Plastik</option>
                            <option value="shisha">Shisha</option>
                            <option value="boshqa">Boshqa</option>
                        </select>
                    </div>
                    <div class="col-md-1 mb-3">
                        <label class="form-label">Yuzasi</label>
                        <div class="input-group">
                            <input type="text" class="form-control door-area" readonly style="background-color: #e9ecef;">
                            <span class="input-group-text">m²</span>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger remove-btn w-100 mt-2" onclick="this.closest('.door-window-item').remove(); calculateDoorWindowAreas();">
                            <i class="bi bi-trash"></i> O'chirish
                        </button>
                    </div>
                </div>
                <div class="resistance-display">
                    <strong>Umumiy qarshilik (R<span class="r-subscript">um</span>): <span class="door-resistance">0.6</span> m²·°C/W</strong>
                    <br>
                    <strong>Umumiy Issiqlik (Q<span class="r-subscript">um</span>): <span class="door-q">0</span> kW h/m²y</strong>
                </div>
            `;
            container.appendChild(doorItem);
            
            // Counter funksiyallari
            const minusBtn = doorItem.querySelector('.minus-btn');
            const plusBtn = doorItem.querySelector('.plus-btn');
            const counterValue = doorItem.querySelector('.counter-value');
            
            let count = 1;
            
            minusBtn.addEventListener('click', function() {
                if (count > 1) {
                    count--;
                    counterValue.textContent = count;
                    calculateDoorArea();
                }
            });
            
            plusBtn.addEventListener('click', function() {
                count++;
                counterValue.textContent = count;
                calculateDoorArea();
            });
            
            // Eshik o'lchamlari o'zgarganda yuzani hisoblash
            const widthInput = doorItem.querySelector('.door-width');
            const heightInput = doorItem.querySelector('.door-height');
            const areaInput = doorItem.querySelector('.door-area');
            
            function calculateDoorArea() {
                const width = parseFloat(widthInput.value) || 0;
                const height = parseFloat(heightInput.value) || 0;
                const area = width * height * count;
                areaInput.value = area.toFixed(2);
                calculateDoorWindowAreas();
            }
            
            widthInput.addEventListener('input', calculateDoorArea);
            heightInput.addEventListener('input', calculateDoorArea);
            
            // Dastlabki hisoblash
            calculateDoorArea();
        }

        // Deraza qo'shish (YANGILANGAN)
        function addWindowItem(id) {
            const container = document.getElementById('windowsContainer');
            const windowItem = document.createElement('div');
            windowItem.className = 'door-window-item window-item';
            windowItem.innerHTML = `
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Deraza ${id} eni (m)</label>
                        <div class="input-group">
                            <input type="number" class="form-control window-width" min="0" step="0.01" value="1.2">
                            <span class="input-group-text">m</span>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Deraza ${id} balandligi (m)</label>
                        <div class="input-group">
                            <input type="number" class="form-control window-height" min="0" step="0.01" value="1.5">
                            <span class="input-group-text">m</span>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label class="form-label">Soni</label>
                        <div class="counter-input">
                            <div class="counter-btn minus-btn">-</div>
                            <div class="counter-value">1</div>
                            <div class="counter-btn plus-btn">+</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Deraza ${id} materiali</label>
                        <select class="form-select window-material">
                            <option value="yog'och">Yog'och</option>
                            <option value="metall">Metall</option>
                            <option value="plastik">Plastik</option>
                            <option value="alyuminiy">Alyuminiy</option>
                            <option value="boshqa">Boshqa</option>
                        </select>
                    </div>
                    <div class="col-md-1 mb-3">
                        <label class="form-label">Yuzasi</label>
                        <div class="input-group">
                            <input type="text" class="form-control window-area" readonly style="background-color: #e9ecef;">
                            <span class="input-group-text">m²</span>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger remove-btn w-100 mt-2" onclick="this.closest('.door-window-item').remove(); calculateDoorWindowAreas();">
                            <i class="bi bi-trash"></i> O'chirish
                        </button>
                    </div>
                </div>
                <div class="resistance-display">
                    <strong>Umumiy qarshilik (R<span class="r-subscript">um</span>): <span class="window-resistance">0.6</span> m²·°C/W</strong>
                    <br>
                    <strong>Umumiy Issiqlik (Q<span class="r-subscript">um</span>): <span class="window-q">0</span> kW h/m²y</strong>
                </div>
            `;
            container.appendChild(windowItem);
            
            // Counter funksiyallari
            const minusBtn = windowItem.querySelector('.minus-btn');
            const plusBtn = windowItem.querySelector('.plus-btn');
            const counterValue = windowItem.querySelector('.counter-value');
            
            let count = 1;
            
            minusBtn.addEventListener('click', function() {
                if (count > 1) {
                    count--;
                    counterValue.textContent = count;
                    calculateWindowArea();
                }
            });
            
            plusBtn.addEventListener('click', function() {
                count++;
                counterValue.textContent = count;
                calculateWindowArea();
            });
            
            // Deraza o'lchamlari o'zgarganda yuzani hisoblash
            const widthInput = windowItem.querySelector('.window-width');
            const heightInput = windowItem.querySelector('.window-height');
            const areaInput = windowItem.querySelector('.window-area');
            
            function calculateWindowArea() {
                const width = parseFloat(widthInput.value) || 0;
                const height = parseFloat(heightInput.value) || 0;
                const area = width * height * count;
                areaInput.value = area.toFixed(2);
                calculateDoorWindowAreas();
            }
            
            widthInput.addEventListener('input', calculateWindowArea);
            heightInput.addEventListener('input', calculateWindowArea);
            
            // Dastlabki hisoblash
            calculateWindowArea();
        }

        // ========== MAVJUD FUNKSIYALAR ==========

        // Kategoriyalarni to'ldirish
        function populateCategories() {
            const categorySelect = document.getElementById('categorySelect');
            materialData.forEach(category => {
                const option = document.createElement('option');
                option.value = category.category_name;
                option.textContent = category.category_name;
                categorySelect.appendChild(option);
            });
        }
        
        // Material ro'yxatini yuklash funksiyasi
        function loadMaterialList(materialArray) {
            materialList.innerHTML = '';
            
            materialArray.forEach(category => {
                // Kategoriya sarlavhasi
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'category-header fw-bold mt-3 mb-2 text-primary';
                categoryHeader.textContent = category.category_name;
                materialList.appendChild(categoryHeader);
                
                // Subkategoriyalar
                category.subcategories.forEach(subcategory => {
                    // Materiallar
                    subcategory.items.forEach(material => {
                        const materialItem = document.createElement('div');
                        materialItem.className = 'material-item';
                        materialItem.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    ${material.name}
                                    <br><small class="text-muted">Issiqlik o'tkazuvchanlik koeffitsienti: ${material.l} W/(m·°C)</small>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">${category.category_name}</small>
                                </div>
                            </div>
                        `;
                        materialItem.dataset.material = JSON.stringify(material);
                        materialItem.dataset.category = category.category_name;
                        materialItem.dataset.subcategory = subcategory.subcategory;
                        
                        materialItem.addEventListener('click', function() {
                            // Barcha materiallardan tanlangan klassni olib tashlash
                            document.querySelectorAll('.material-item').forEach(item => {
                                item.classList.remove('selected');
                            });
                            // Joriy materialga tanlangan klassni qo'shish
                            this.classList.add('selected');
                            selectedMaterial = JSON.parse(this.dataset.material);
                        });
                        materialList.appendChild(materialItem);
                    });
                });
            });
        }
        
        // Materiallarni filtrlash
        function filterMaterials() {
            const searchTerm = materialSearch.value.toLowerCase();
            const selectedCategory = categorySelect.value;
            
            let filteredData = [];
            
            if (selectedCategory) {
                // Faqat tanlangan kategoriyani qo'shish
                const category = materialData.find(cat => cat.category_name === selectedCategory);
                if (category) {
                    filteredData.push(category);
                }
            } else {
                // Barcha kategoriyalarni qo'shish
                filteredData = [...materialData];
            }
            
            // Agar qidiruv so'zi bo'lsa, filtrlash
            if (searchTerm) {
                filteredData = filteredData.map(category => {
                    const filteredSubcategories = category.subcategories.map(subcategory => {
                        const filteredItems = subcategory.items.filter(item => 
                            item.name.toLowerCase().includes(searchTerm)
                        );
                        return {
                            ...subcategory,
                            items: filteredItems
                        };
                    }).filter(subcategory => subcategory.items.length > 0);
                    
                    return {
                        ...category,
                        subcategories: filteredSubcategories
                    };
                }).filter(category => category.subcategories.length > 0);
            }
            
            // Filtrlangan materiallarni yuklash
            loadMaterialList(filteredData);
        }
        
        // API dan viloyatlarni yuklash
        async function loadRegionsFromAPI() {
            try {
                const response = await fetch('https://calc.tmsiti.uz/api/v1/heating/api/regions-districts/');
                const data = await response.json();
                
                if (data.regions) {
                    regionsData = data.regions;
                    populateRegionsSelect();
                } else {
                    console.error('API dan ma\'lumotlar olinmadi');
                    // Agar API ishlamasa, fallback ma'lumotlarni yuklash
                    loadFallbackData();
                }
            } catch (error) {
                console.error('API dan ma\'lumotlar olishda xatolik:', error);
                // Agar API ishlamasa, fallback ma'lumotlarni yuklash
                loadFallbackData();
            }
        }
        
        // Fallback ma'lumotlar
        function loadFallbackData() {
            regionsData = [
                {
                    name: "Qoraqalpog'iston Respublikasi",
                    districts: [
                        { name: "Qoraqalpog", average_temperature: -2.4, time: 174 },
                        { name: "Moynoq", average_temperature: -1.2, time: 167 },
                        { name: "Nukus", average_temperature: -0.6, time: 143 },
                        { name: "Chimboy", average_temperature: -1.3, time: 163 }
                    ]
                },
                {
                    name: "Toshkent viloyati",
                    districts: [
                        { name: "Toshkent", average_temperature: 2.7, time: 129 },
                        { name: "Olmaliq", average_temperature: 3.2, time: 124 },
                        { name: "Ohangaron", average_temperature: 2.9, time: 135 }
                    ]
                },
                {
                    name: "Farg'ona viloyati",
                    districts: [
                        { name: "Farg'ona", average_temperature: 1.8, time: 131 },
                        { name: "Qo'qon", average_temperature: 1.9, time: 132 }
                    ]
                }
            ];
            populateRegionsSelect();
        }
        
        // Viloyatlarni select elementiga yuklash
        function populateRegionsSelect() {
            const regionSelect = document.getElementById('region');
            regionSelect.innerHTML = '<option value="" selected disabled>Viloyatni tanlang</option>';
            
            regionsData.forEach(region => {
                const option = document.createElement('option');
                option.value = region.name;
                option.textContent = region.name;
                option.setAttribute('data-region', JSON.stringify(region));
                regionSelect.appendChild(option);
            });
            
            // Viloyat tanlanganda tumanlarni yuklash
            regionSelect.addEventListener('change', function() {
                const districtSelect = document.getElementById('district');
                const selectedOption = this.options[this.selectedIndex];
                
                if (selectedOption.value) {
                    selectedRegionData = JSON.parse(selectedOption.getAttribute('data-region'));
                    districtSelect.innerHTML = '';
                    districtSelect.disabled = false;
                    
                    selectedRegionData.districts.forEach(district => {
                        const option = document.createElement('option');
                        option.value = district.name;
                        option.textContent = district.name;
                        option.setAttribute('data-district', JSON.stringify(district));
                        districtSelect.appendChild(option);
                    });
                    
                    // Tuman tanlanganda ma'lumotlarni ko'rsatish
                    districtSelect.addEventListener('change', function() {
                        const selectedDistrictOption = this.options[this.selectedIndex];
                        if (selectedDistrictOption.value) {
                            selectedDistrictData = JSON.parse(selectedDistrictOption.getAttribute('data-district'));
                            displayRegionInfo();
                        }
                    });
                } else {
                    districtSelect.disabled = true;
                    document.getElementById('regionInfo').style.display = 'none';
                }
            });
        }
        
        // Hudud ma'lumotlarini ko'rsatish
        function displayRegionInfo() {
            if (selectedDistrictData) {
                document.getElementById('avgTempDisplay').textContent = selectedDistrictData.average_temperature;
                document.getElementById('timeDisplay').textContent = selectedDistrictData.time;
                document.getElementById('baseTempDisplay').textContent = baseTemperature;
                
                const calcValue = (baseTemperature - selectedDistrictData.average_temperature) * selectedDistrictData.time;
                
                document.getElementById('calcValueDisplay').textContent = calcValue.toFixed(2);
                document.getElementById('regionInfo').style.display = 'block';
            }
        }
        
        // Bosqichga o'tish funksiyasi
        function goToStep(stepNumber) {
            // Bosqichlarni yangilash
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active', 'completed');
                const stepNum = step.getAttribute('data-step');
                if (stepNum < stepNumber) {
                    step.classList.add('completed');
                } else if (stepNum == stepNumber) {
                    step.classList.add('active');
                }
            });
            
            // Form bo'limlarini yangilash
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`step-${stepNumber}`).classList.add('active');
        }
        
        // Eshik va derazalarning umumiy yuzasini hisoblash
        function calculateDoorWindowAreas() {
            let totalDoorsArea = 0;
            let totalWindowsArea = 0;
            
            // Eshiklarning yuzasini hisoblash
            document.querySelectorAll('.door-area').forEach(areaInput => {
                totalDoorsArea += parseFloat(areaInput.value) || 0;
            });
            
            // Derazalarning yuzasini hisoblash
            document.querySelectorAll('.window-area').forEach(areaInput => {
                totalWindowsArea += parseFloat(areaInput.value) || 0;
            });
            
            // Jami yuzalarni ko'rsatish
            document.getElementById('totalDoorsArea').textContent = totalDoorsArea.toFixed(2);
            document.getElementById('totalWindowsArea').textContent = totalWindowsArea.toFixed(2);
            
            // Yakuniy devor yuzasini hisoblash
            const wallArea = parseFloat(document.getElementById('wallArea').value) || 0;
            const finalWallArea = wallArea - totalDoorsArea - totalWindowsArea;
            document.getElementById('finalWallArea').textContent = finalWallArea.toFixed(2);
        }
        
        // Yuzalarni hisoblash funksiyasi
        function calculateAreas() {
            const length = parseFloat(document.getElementById('length').value) || 0;
            const width = parseFloat(document.getElementById('width').value) || 0;
            const height = parseFloat(document.getElementById('height').value) || 0;
            
            // Devorlar yuzasi (2*(uzunlik+eni)*balandlik)
            const wallArea = 2 * (length + width) * height;
            document.getElementById('wallArea').value = wallArea.toFixed(2);
            document.getElementById('wallAreaDisplay').textContent = wallArea.toFixed(2) + ' m²';
            
            // Pol yuzasi (uzunlik * eni)
            const floorArea = length * width;
            document.getElementById('floorArea').value = floorArea.toFixed(2);
            document.getElementById('floorAreaDisplay').textContent = floorArea.toFixed(2) + ' m²';
            
            // Tom yuzasi (uzunlik * eni)
            const ceilingArea = length * width;
            document.getElementById('ceilingArea').value = ceilingArea.toFixed(2);
            document.getElementById('ceilingAreaDisplay').textContent = ceilingArea.toFixed(2) + ' m²';
            
            // Bino hajmi (uzunlik * eni * balandlik)
            const volume = length * width * height;
            document.getElementById('volumeDisplay').textContent = volume.toFixed(2) + ' m³';
            
            // Eshik va derazalarning yuzasini qayta hisoblash
            calculateDoorWindowAreas();
        }
        
        // Isitish qiymatini hisoblash
        function calculateHeating() {
            if (!selectedDistrictData) {
                alert('Iltimos, avval hududni tanlang!');
                goToStep(1);
                return;
            }
            
            // Ma'lumotlarni yig'ish
            const region = document.getElementById('region').value;
            const district = document.getElementById('district').value;
            const buildingType = document.getElementById('buildingType').value;
            const customBuildingType = document.getElementById('customBuildingType').value;
            const length = document.getElementById('length').value;
            const width = document.getElementById('width').value;
            const height = document.getElementById('height').value;
            
            // Bino turi nomini olish
            const buildingTypeSelect = document.getElementById('buildingType');
            const selectedBuildingOption = buildingTypeSelect.options[buildingTypeSelect.selectedIndex];
            const buildingTypeName = buildingType === 'boshqa' ? customBuildingType : selectedBuildingOption.textContent;
            
            // Bino hajmini hisoblash
            const volume = (parseFloat(length) || 0) * (parseFloat(width) || 0) * (parseFloat(height) || 0);
            
            // Qarshiliklarni olish
            const wallResistance = parseFloat(document.getElementById('wallTotalResistance').textContent) || 0;
            const floorResistance = parseFloat(document.getElementById('floorTotalResistance').textContent) || 0;
            const ceilingResistance = parseFloat(document.getElementById('ceilingTotalResistance').textContent) || 0;
            
            // Eshik va derazalar uchun qarshilik (0.6)
            const doorResistance = 0.6;
            const windowResistance = 0.6;
            
            // Yuzalarni olish
            const wallArea = parseFloat(document.getElementById('finalWallArea').textContent) || 0;
            const floorArea = parseFloat(document.getElementById('floorArea').value) || 0;
            const ceilingArea = parseFloat(document.getElementById('ceilingArea').value) || 0;
            
            // Eshik va derazalar yuzasi
            const totalDoorsArea = parseFloat(document.getElementById('totalDoorsArea').textContent) || 0;
            const totalWindowsArea = parseFloat(document.getElementById('totalWindowsArea').textContent) || 0;
            
            // Harorat farqi
            const tempDifference = baseTemperature - selectedDistrictData.average_temperature;
            
            // Q qiymatlarini hisoblash: Q = (1/R) * (joy - average_temperature) * time * 24 * S
            const time = selectedDistrictData.time;
            const wallQ = (1 / (wallResistance || 1)) * tempDifference * time * 24 * wallArea;
            const floorQ = (1 / (floorResistance || 1)) * tempDifference * time * 24 * floorArea;
            const ceilingQ = (1 / (ceilingResistance || 1)) * tempDifference * time * 24 * ceilingArea;
            const doorQ = (1 / doorResistance) * tempDifference * time * 24 * totalDoorsArea;
            const windowQ = (1 / windowResistance) * tempDifference * time * 24 * totalWindowsArea;
            
            // Havo almashinuv orqali issiqlik yo'qotilishi
            const floorAreaValue = parseFloat(document.getElementById('floorArea').value) || 0;
            const airExchangeQ = ((floorAreaValue * 4 * 24 * time * 1.2*0.35)*(tempDifference))/ 1000;
            
            // Umumiy issiqlik yo'qotilishi
            const totalQ = wallQ + floorQ + ceilingQ + doorQ + windowQ + airExchangeQ;
            
            // Natijalarni ko'rsatish
            document.getElementById('resultRegion').textContent = region;
            document.getElementById('resultDistrict').textContent = district;
            document.getElementById('resultBuildingType').textContent = buildingTypeName;
            document.getElementById('resultAvgTemp').textContent = selectedDistrictData.average_temperature;
            document.getElementById('resultBaseTemp').textContent = baseTemperature;
            document.getElementById('resultTime').textContent = selectedDistrictData.time;
            document.getElementById('resultDimensions').textContent = `${length}m × ${width}m × ${height}m`;
            document.getElementById('resultVolume').textContent = volume.toFixed(2);
            document.getElementById('resultWallResistance').textContent = wallResistance.toFixed(3);
            document.getElementById('resultFloorResistance').textContent = floorResistance.toFixed(3);
            document.getElementById('resultCeilingResistance').textContent = ceilingResistance.toFixed(3);
            
            // Q qiymatlarini ko'rsatish
            document.getElementById('resultWallQ').textContent = (wallQ / 1000).toFixed(2);
            document.getElementById('resultFloorQ').textContent = (floorQ / 1000).toFixed(2);
            document.getElementById('resultCeilingQ').textContent = (ceilingQ / 1000).toFixed(2);
            document.getElementById('resultDoorQ').textContent = (doorQ / 1000).toFixed(2);
            document.getElementById('resultWindowQ').textContent = (windowQ / 1000).toFixed(2);
            document.getElementById('resultAirExchangeQ').textContent = airExchangeQ.toFixed(2);
            document.getElementById('resultTotalQ').textContent = (totalQ / 1000).toFixed(2);
            
            // Material qismlarida Q qiymatlarini yangilash
            document.getElementById('wallTotalQ').textContent = (wallQ / 1000).toFixed(2);
            document.getElementById('floorTotalQ').textContent = (floorQ / 1000).toFixed(2);
            document.getElementById('ceilingTotalQ').textContent = (ceilingQ / 1000).toFixed(2);
            
            // Eshik va derazalarda Q qiymatlarini yangilash
            document.querySelectorAll('.door-q').forEach(element => {
                element.textContent = (doorQ / 1000).toFixed(2);
            });
            
            document.querySelectorAll('.window-q').forEach(element => {
                element.textContent = (windowQ / 1000).toFixed(2);
            });
            
            // Natijalarni ko'rsatish
            document.getElementById('calculationResult').style.display = 'block';
            
            // Natijalarga scroll qilish
            document.getElementById('calculationResult').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Material modalini ochish
        function openMaterialModal(section) {
            currentSection = section;
            const modal = new bootstrap.Modal(document.getElementById('materialModal'));
            modal.show();
        }
        
        // Materialni qismga qo'shish
        function addMaterialToSection(section, material) {
            // Qatlam obyektini yaratish
            const layer = {
                id: Date.now(),
                name: material.name,
                l: material.l,
                thickness: 0.1
            };
            
            // Tegishli qismga qo'shish
            if (section === 'wall') {
                wallLayers.push(layer);
                updateLayerTable('wall', wallLayers);
                document.getElementById('wallMaterialDisplay').value = `${wallLayers.length} ta material`;
            } else if (section === 'floor') {
                floorLayers.push(layer);
                updateLayerTable('floor', floorLayers);
                document.getElementById('floorMaterialDisplay').value = `${floorLayers.length} ta material`;
            } else if (section === 'ceiling') {
                ceilingLayers.push(layer);
                updateLayerTable('ceiling', ceilingLayers);
                document.getElementById('ceilingMaterialDisplay').value = `${ceilingLayers.length} ta material`;
            }
        }
        
        // Qatlamlar jadvalini yangilash
        function updateLayerTable(section, layers) {
            const containerId = `${section}LayersContainer`;
            const tableId = `${section}LayerTable`;
            const container = document.getElementById(containerId);
            const table = document.getElementById(tableId);
            
            // Agar materiallar mavjud bo'lsa, jadvalni ko'rsatish
            if (layers.length > 0) {
                table.style.display = 'block';
            } else {
                table.style.display = 'none';
            }
            
            // Jadvalni tozalash
            container.innerHTML = '';
            
            // Har bir qatlam uchun qator yaratish
            layers.forEach((layer, index) => {
                const layerRow = document.createElement('div');
                layerRow.className = 'layer-row row align-items-center';
                layerRow.innerHTML = `
                    <div class="col-md-5">
                        <span>${layer.name}</span>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">l = ${layer.l}</small>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control layer-thickness" 
                                   data-id="${layer.id}" data-section="${section}"
                                   min="0" step="0.01" value="${layer.thickness}">
                            <span class="input-group-text">m</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-sm btn-outline-danger remove-layer" 
                                data-id="${layer.id}" data-section="${section}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(layerRow);
            });
            
            // Qatlam qalinligini o'zgartirganda
            document.querySelectorAll('.layer-thickness').forEach(input => {
                input.addEventListener('input', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    const section = this.getAttribute('data-section');
                    const thickness = parseFloat(this.value) || 0;
                    
                    updateLayerThickness(section, id, thickness);
                });
            });
            
            // Qatlamni o'chirish tugmasi
            document.querySelectorAll('.remove-layer').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    const section = this.getAttribute('data-section');
                    
                    removeLayer(section, id);
                });
            });
            
            // Jami qalinlikni yangilash
            updateTotalThickness(section);
            // Qarshilikni yangilash
            updateResistance(section);
        }
        
        // Qatlam qalinligini yangilash
        function updateLayerThickness(section, id, thickness) {
            let layers;
            if (section === 'wall') {
                layers = wallLayers;
            } else if (section === 'floor') {
                layers = floorLayers;
            } else if (section === 'ceiling') {
                layers = ceilingLayers;
            }
            
            // Qatlamni topish va yangilash
            const layerIndex = layers.findIndex(layer => layer.id === id);
            if (layerIndex !== -1) {
                layers[layerIndex].thickness = thickness;
                updateTotalThickness(section);
                updateResistance(section);
            }
        }
        
        // Qatlamni o'chirish
        function removeLayer(section, id) {
            let layers;
            if (section === 'wall') {
                layers = wallLayers;
            } else if (section === 'floor') {
                layers = floorLayers;
            } else if (section === 'ceiling') {
                layers = ceilingLayers;
            }
            
            // Qatlamni olib tashlash
            const layerIndex = layers.findIndex(layer => layer.id === id);
            if (layerIndex !== -1) {
                layers.splice(layerIndex, 1);
                updateLayerTable(section, layers);
                
                // Material display ni yangilash
                const displayId = `${section}MaterialDisplay`;
                document.getElementById(displayId).value = layers.length > 0 ? `${layers.length} ta material` : '';
                
                // Qarshilikni yangilash
                updateResistance(section);
            }
        }
        
        // Jami qalinlikni yangilash
        function updateTotalThickness(section) {
            let layers, totalThicknessId, thicknessInputId;
            
            if (section === 'wall') {
                layers = wallLayers;
                totalThicknessId = 'wallTotalThickness';
                thicknessInputId = 'wallThickness';
            } else if (section === 'floor') {
                layers = floorLayers;
                totalThicknessId = 'floorTotalThickness';
                thicknessInputId = 'floorThickness';
            } else if (section === 'ceiling') {
                layers = ceilingLayers;
                totalThicknessId = 'ceilingTotalThickness';
                thicknessInputId = 'ceilingThickness';
            }
            
            // Jami qalinlikni hisoblash
            const totalThickness = layers.reduce((sum, layer) => sum + (layer.thickness || 0), 0);
            
            // Jami qalinlikni ko'rsatish
            document.getElementById(totalThicknessId).textContent = `Jami qalinlik: ${totalThickness.toFixed(2)} m`;
            
            // Qalinlik inputini yangilash
            document.getElementById(thicknessInputId).value = totalThickness.toFixed(2);
        }